<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI å¤§é€ƒæ®º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    /* å·¦å´é¢æ¿ */
    .sidebar {
      width: 320px;
      background: rgba(26, 26, 46, 0.95);
      border-right: 1px solid #333;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .logo {
      color: #ff6b6b;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 30px;
    }

    .logo::before {
      content: "ğŸ®";
      margin-right: 10px;
    }

    .section-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #fff;
    }

    .ai-config {
      margin-bottom: 30px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #ccc;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      background: #2d2d44;
      border: 1px solid #444;
      border-radius: 5px;
      color: white;
      font-size: 14px;
    }

    .test-btn {
      width: 100%;
      padding: 12px;
      background: #ff6b6b;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .test-btn:hover {
      background: #ff5252;
    }

    .test-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    /* éŠæˆ²ç‹€æ…‹ */
    .game-status {
      margin-bottom: 30px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .status-value {
      font-weight: bold;
    }

    .status-value.survivors {
      color: #ff6b6b;
    }

    .status-value.area {
      color: #ffa726;
    }

    .status-value.time {
      color: #66bb6a;
    }

    .status-value.health {
      color: #4caf50;
    }

    .health-bar {
      width: 100%;
      height: 8px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .health-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      transition: width 0.5s ease;
    }

    /* èƒŒåŒ…ç‰©å“ */
    .inventory {
      margin-top: auto;
    }

    .inventory-items {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .inventory-item {
      aspect-ratio: 1;
      background: #2d2d44;
      border: 2px solid #444;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .inventory-item.has-item {
      border-color: #ff6b6b;
      background: #3d2d44;
    }

    .inventory-item:hover {
      border-color: #66bb6a;
    }

    /* ä¸»è¦éŠæˆ²å€åŸŸ */
    .main-area {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .location {
      display: flex;
      align-items: center;
      color: #ff6b6b;
    }

    .countdown {
      display: flex;
      align-items: center;
      color: #ffa726;
    }

    .ai-status {
      color: #4caf50;
    }

    /* AI æ•˜è¿°å€ */
    .story-area {
      background: rgba(45, 45, 68, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      min-height: 200px;
      flex-grow: 1;
    }

    .ai-narrator {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .ai-avatar {
      width: 40px;
      height: 40px;
      background: #ff6b6b;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 18px;
    }

    .ai-message {
      flex: 1;
      line-height: 1.6;
    }

    .ai-name {
      font-weight: bold;
      color: #ff6b6b;
      margin-bottom: 5px;
    }

    .story-text {
      margin-bottom: 20px;
    }

    .choices-prompt {
      color: #ffa726;
      font-weight: bold;
      margin-bottom: 15px;
    }

    /* é¸æ“‡æŒ‰éˆ• */
    .choices-area {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .choice-btn {
      padding: 20px;
      background: rgba(45, 45, 68, 0.8);
      border: 2px solid #444;
      border-radius: 15px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      display: flex;
      align-items: center;
    }

    .choice-btn:hover {
      border-color: #66bb6a;
      background: rgba(66, 66, 88, 0.9);
    }

    .choice-btn.attack {
      border-color: #ff6b6b;
    }

    .choice-btn.stealth {
      border-color: #2196f3;
    }

    .choice-btn.retreat {
      border-color: #4caf50;
    }

    .choice-btn.explore {
      border-color: #ffa726;
    }

    .choice-btn:hover.attack {
      border-color: #ff8a80;
      background: rgba(255, 107, 107, 0.1);
    }

    .choice-btn:hover.stealth {
      border-color: #90caf9;
      background: rgba(33, 150, 243, 0.1);
    }

    .choice-btn:hover.retreat {
      border-color: #a5d6a7;
      background: rgba(76, 175, 80, 0.1);
    }

    .choice-btn:hover.explore {
      border-color: #ffcc02;
      background: rgba(255, 167, 38, 0.1);
    }

    .choice-icon {
      font-size: 24px;
      margin-right: 15px;
    }

    .choice-content h3 {
      margin-bottom: 5px;
      font-size: 16px;
    }

    .choice-content p {
      font-size: 14px;
      color: #ccc;
      line-height: 1.4;
    }

    /* éŠæˆ²è¨˜éŒ„ */
    .game-log {
      background: rgba(45, 45, 68, 0.6);
      border-radius: 10px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-title {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .log-entry {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 5px 0;
      font-size: 14px;
    }

    .log-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .log-icon.success {
      background: #4caf50;
    }

    .log-icon.danger {
      background: #ff6b6b;
    }

    .log-icon.info {
      background: #2196f3;
    }

    .log-time {
      color: #888;
      margin-right: 10px;
    }

    /* Loading å‹•ç•« */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #333;
      border-radius: 50%;
      border-top-color: #ff6b6b;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      color: #888;
      font-style: italic;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #333;
      }

      .choices-area {
        grid-template-columns: 1fr;
      }
    }

    /* éŠæˆ²çµæŸç•«é¢ */
    .game-over {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .game-over-content {
      background: #1a1a2e;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      border: 2px solid #ff6b6b;
    }

    .game-over h2 {
      color: #ff6b6b;
      margin-bottom: 20px;
      font-size: 32px;
    }

    .restart-btn {
      padding: 15px 30px;
      background: #4caf50;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }

    .restart-btn:hover {
      background: #45a049;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- å·¦å´é¢æ¿ -->
    <div class="sidebar">
      <div class="logo">AI å¤§é€ƒæ®º</div>

      <!-- AI æ¨¡å‹è¨­å®š -->
      <div class="ai-config">
        <h3 class="section-title">AI æ¨¡å‹è¨­å®š</h3>
        <div class="input-group">
          <label>Ollama API URL</label>
          <input type="text" id="apiUrl" value="http://localhost:11434" placeholder="API URL">
        </div>
        <div class="input-group">
          <label>API Key</label>
          <input type="password" id="apiKey" placeholder="è¼¸å…¥ API Keyï¼ˆé¸å¡«ï¼‰">
        </div>
        <div class="input-group">
          <label>æ¨¡å‹åç¨±</label>
          <input type="text" id="modelName" value="llama3.2:7b" placeholder="ä¾‹å¦‚ï¼šllama3.2:7b">
        </div>
        <button class="test-btn" onclick="testConnection()">ğŸ”— æ¸¬è©¦é€£æ¥</button>
      </div>

      <!-- éŠæˆ²ç‹€æ…‹ -->
      <div class="game-status">
        <h3 class="section-title">éŠæˆ²ç‹€æ…‹</h3>
        <div class="status-item">
          <span>å­˜æ´»äººæ•¸</span>
          <span class="status-value survivors" id="survivors">42/100</span>
        </div>
        <div class="status-item">
          <span>å®‰å…¨å€åŸŸ</span>
          <span class="status-value area" id="safeZone">ç¸®å°ä¸­</span>
        </div>
        <div class="status-item">
          <span>éŠæˆ²æ™‚é–“</span>
          <span class="status-value time" id="gameTime">12:34</span>
        </div>
        <div class="status-item">
          <span>ç”Ÿå‘½å€¼</span>
          <span class="status-value health" id="healthValue">85/100</span>
        </div>
        <div class="health-bar">
          <div class="health-fill" id="healthBar" style="width: 85%"></div>
        </div>
      </div>

      <!-- èƒŒåŒ…ç‰©å“ -->
      <div class="inventory">
        <h3 class="section-title">èƒŒåŒ…ç‰©å“</h3>
        <div class="inventory-items">
          <div class="inventory-item has-item" title="AK-47">ğŸ”«</div>
          <div class="inventory-item has-item" title="é˜²å½ˆè¡£">ğŸ›¡ï¸</div>
          <div class="inventory-item has-item" title="é†«ç™‚åŒ…">ğŸ¥</div>
          <div class="inventory-item" title="ç©ºæ ¼"></div>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦éŠæˆ²å€åŸŸ -->
    <div class="main-area">
      <!-- éŠæˆ²æ¨™é¡Œ -->
      <div class="game-header">
        <div class="location">ğŸ“ ä½ç½®ï¼šå»¢æ£„å·¥å» </div>
        <div class="countdown">â±ï¸ æ¯’åœˆç¸®å°ï¼š2:15</div>
        <div class="ai-status" id="connectionStatus">ğŸŸ¢ AI å·²é€£æ¥</div>
      </div>

      <!-- AI æ•˜è¿°å€åŸŸ -->
      <div class="story-area">
        <div class="ai-narrator">
          <div class="ai-avatar">ğŸ¤–</div>
          <div class="ai-message">
            <div class="ai-name">AI æ•˜è¿°è€… å‰›å‰›</div>
            <div class="story-text" id="storyText">
              ä½ å°å¿ƒç¿¼ç¿¼åœ°æ½›è¡Œåœ¨å»¢æ£„å·¥å» çš„é™°å½±ä¸­ï¼Œé è™•å‚³ä¾†æ§è²å’Œçˆ†ç‚¸è²ã€‚çªç„¶ï¼Œä½ è½åˆ°è…³æ­¥è²å¾å´ç¿¼å‚³ä¾†ï¼Œä¼¼ä¹æœ‰å…¶ä»–ç©å®¶æ­£åœ¨æ¥è¿‘ä½ çš„ä½ç½®ã€‚
              <br><br>
              ä½ çš„å¿ƒè·³åŠ é€Ÿï¼Œæ‰‹ç·Šæ¡è‘— AK-47ï¼Œé€éç ´ç¢çš„çª—æˆ¶ï¼Œä½ çœ‹åˆ°ä¸€å€‹èº«å½±æ­£åœ¨å°å¿ƒåœ°æœç´¢é™„è¿‘çš„å»ºç¯‰ç‰©ã€‚æ¯’åœˆæ­£åœ¨ç¸®å°ï¼Œä½ å¿…é ˆåšå‡ºæ±ºå®š...
            </div>
            <div class="choices-prompt">ä½ ç¾åœ¨æœ‰ä»¥ä¸‹é¸æ“‡ï¼š</div>
          </div>
        </div>
      </div>

      <!-- é¸æ“‡æŒ‰éˆ•å€åŸŸ -->
      <div class="choices-area" id="choicesArea">
        <button class="choice-btn attack" onclick="makeChoice('attack')">
          <div class="choice-icon">âš”ï¸</div>
          <div class="choice-content">
            <h3>ä¸»å‹•æ”»æ“Š</h3>
            <p>è¶å°æ–¹ä¸æ³¨æ„ç™¼å‹•çªè¥²ï¼Œè©¦åœ–æ¶ˆæ»…å¨è„…</p>
          </div>
        </button>
        <button class="choice-btn stealth" onclick="makeChoice('stealth')">
          <div class="choice-icon">ğŸ‘ï¸</div>
          <div class="choice-content">
            <h3>æš—ä¸­è§€å¯Ÿ</h3>
            <p>ä¿æŒéš±è—ï¼Œè§€å¯Ÿå°æ–¹çš„è¡Œå‹•ä¸¦ç­‰å¾…æ™‚æ©Ÿ</p>
          </div>
        </button>
        <button class="choice-btn retreat" onclick="makeChoice('retreat')">
          <div class="choice-icon">ğŸƒ</div>
          <div class="choice-content">
            <h3>æ‚„æ‚„æ’¤é€€</h3>
            <p>é¿å…è¡çªï¼Œå°‹æ‰¾å…¶ä»–è·¯ç·šç¹¼çºŒå‰é€²</p>
          </div>
        </button>
        <button class="choice-btn explore" onclick="makeChoice('explore')">
          <div class="choice-icon">ğŸ”</div>
          <div class="choice-content">
            <h3>å¯¦é©—æºé€š</h3>
            <p>å†’éšªå˜—è©¦èˆ‡å°æ–¹å»ºç«‹è¯ç›Ÿé—œä¿‚</p>
          </div>
        </button>
      </div>

      <!-- éŠæˆ²è¨˜éŒ„ -->
      <div class="game-log">
        <div class="log-title">
          <span>ğŸ• éŠæˆ²è¨˜éŒ„</span>
        </div>
        <div id="logEntries">
          <div class="log-entry">
            <div class="log-icon success">âœ“</div>
            <span class="log-time">12:30</span>
            <span>æˆåŠŸæ‰¾åˆ°é˜²å½ˆè¡£ï¼Œé˜²è­·åŠ›æå‡</span>
          </div>
          <div class="log-entry">
            <div class="log-icon danger">âœ—</div>
            <span class="log-time">12:25</span>
            <span>èˆ‡æ•µäººäº¤ç«ï¼Œæ¶ˆè€—äº†å¤§é‡å½ˆè—¥</span>
          </div>
          <div class="log-entry">
            <div class="log-icon info">â„¹</div>
            <span class="log-time">12:20</span>
            <span>ç™¼ç¾é†«ç™‚åŒ…ï¼Œç”Ÿå‘½å€¼å®Œå…¨æ¢å¾©</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // éŠæˆ²ç‹€æ…‹
    let gameState = {
      survivors: 42,
      maxSurvivors: 100,
      health: 85,
      maxHealth: 100,
      gameTime: 754, // ç§’
      safeZoneTime: 135, // æ¯’åœˆç¸®å°å€’è¨ˆæ™‚
      location: 'å»¢æ£„å·¥å» ',
      inventory: ['AK-47', 'é˜²å½ˆè¡£', 'é†«ç™‚åŒ…'],
      isConnected: false,
      isGameOver: false
    };

    // API è¨­å®š
    let apiConfig = {
      url: 'http://localhost:11434',
      key: '',
      model: 'llama3.2:7b'
    };

    // éŠæˆ²åˆå§‹åŒ–
    function initGame() {
      updateGameStatus();
      startGameTimer();
      loadApiConfig();
    }

    // è¼‰å…¥ API è¨­å®š
    function loadApiConfig() {
      const savedUrl = localStorage.getItem('apiUrl');
      const savedKey = localStorage.getItem('apiKey');
      const savedModel = localStorage.getItem('modelName');

      if (savedUrl) document.getElementById('apiUrl').value = savedUrl;
      if (savedKey) document.getElementById('apiKey').value = savedKey;
      if (savedModel) document.getElementById('modelName').value = savedModel;
    }

    // æ¸¬è©¦ API é€£æ¥
    async function testConnection() {
      const apiUrl = document.getElementById('apiUrl').value;
      const apiKey = document.getElementById('apiKey').value;
      const modelName = document.getElementById('modelName').value;

      const testBtn = document.querySelector('.test-btn');
      testBtn.disabled = true;
      testBtn.innerHTML = '<div class="loading"></div>æ¸¬è©¦ä¸­...';

      try {
        // å„²å­˜è¨­å®š
        apiConfig = { url: apiUrl, key: apiKey, model: modelName };
        localStorage.setItem('apiUrl', apiUrl);
        localStorage.setItem('apiKey', apiKey);
        localStorage.setItem('modelName', modelName);

        // æ¸¬è©¦é€£æ¥ï¼ˆé€™è£¡ä½¿ç”¨æ¨¡æ“¬æ¸¬è©¦ï¼‰
        await new Promise(resolve => setTimeout(resolve, 2000));

        gameState.isConnected = true;
        updateConnectionStatus();
        testBtn.innerHTML = 'âœ… é€£æ¥æˆåŠŸ';
        testBtn.style.background = '#4caf50';

        setTimeout(() => {
          testBtn.innerHTML = 'ğŸ”— æ¸¬è©¦é€£æ¥';
          testBtn.style.background = '#ff6b6b';
          testBtn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('é€£æ¥æ¸¬è©¦å¤±æ•—:', error);
        testBtn.innerHTML = 'âŒ é€£æ¥å¤±æ•—';
        testBtn.style.background = '#f44336';

        setTimeout(() => {
          testBtn.innerHTML = 'ğŸ”— æ¸¬è©¦é€£æ¥';
          testBtn.style.background = '#ff6b6b';
          testBtn.disabled = false;
        }, 2000);
      }
    }

    // æ›´æ–°é€£æ¥ç‹€æ…‹
    function updateConnectionStatus() {
      const status = document.getElementById('connectionStatus');
      if (gameState.isConnected) {
        status.innerHTML = 'ğŸŸ¢ AI å·²é€£æ¥';
        status.className = 'ai-status';
      } else {
        status.innerHTML = 'ğŸ”´ AI æœªé€£æ¥';
        status.className = 'ai-status disconnected';
      }
    }

    // æ›´æ–°éŠæˆ²ç‹€æ…‹é¡¯ç¤º
    function updateGameStatus() {
      document.getElementById('survivors').textContent = `${gameState.survivors}/${gameState.maxSurvivors}`;
      document.getElementById('healthValue').textContent = `${gameState.health}/${gameState.maxHealth}`;
      document.getElementById('healthBar').style.width = `${(gameState.health / gameState.maxHealth) * 100}%`;

      // æ›´æ–°æ™‚é–“
      const minutes = Math.floor(gameState.gameTime / 60);
      const seconds = gameState.gameTime % 60;
      document.getElementById('gameTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      // æ›´æ–°æ¯’åœˆå€’è¨ˆæ™‚
      const zoneMinutes = Math.floor(gameState.safeZoneTime / 60);
      const zoneSeconds = gameState.safeZoneTime % 60;
      document.querySelector('.countdown').innerHTML = `â±ï¸ æ¯’åœˆç¸®å°ï¼š${zoneMinutes}:${zoneSeconds.toString().padStart(2, '0')}`;
    }

    // é–‹å§‹éŠæˆ²è¨ˆæ™‚å™¨
    function startGameTimer() {
      setInterval(() => {
        if (!gameState.isGameOver) {
          gameState.gameTime++;
          gameState.safeZoneTime--;

          if (gameState.safeZoneTime <= 0) {
            gameState.safeZoneTime = 180; // é‡ç½®ç‚º3åˆ†é˜
            gameState.health -= 10; // æ¯’åœˆå‚·å®³
            addLogEntry('danger', 'æ¯’åœˆå‚·å®³ï¼ç”Ÿå‘½å€¼ä¸‹é™');
          }

          // éš¨æ©Ÿäº‹ä»¶
          if (Math.random() < 0.01) { // 1% æ©Ÿç‡
            gameState.survivors--;
            addLogEntry('info', 'æœ‰ç©å®¶è¢«æ·˜æ±°');
          }

          updateGameStatus();

          if (gameState.health <= 0) {
            endGame('æ­»äº¡');
          } else if (gameState.survivors <= 1) {
            endGame('å‹åˆ©');
          }
        }
      }, 1000);
    }

    // ç©å®¶é¸æ“‡
    async function makeChoice(choice) {
      if (!gameState.isConnected) {
        alert('è«‹å…ˆæ¸¬è©¦é€£æ¥ AI æ¨¡å‹ï¼');
        return;
      }

      // ç¦ç”¨æ‰€æœ‰é¸æ“‡æŒ‰éˆ•
      const buttons = document.querySelectorAll('.choice-btn');
      buttons.forEach(btn => btn.disabled = true);

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      showTypingIndicator();

      try {
        // ç”Ÿæˆæ–°çš„æ•…äº‹å…§å®¹
        const newStory = await generateStory(choice);

        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        updateGameStateFromChoice(choice);

        // é¡¯ç¤ºæ–°æ•…äº‹
        displayStory(newStory);

        // è¨˜éŒ„é¸æ“‡
        addLogEntry('info', getChoiceLogText(choice));

      } catch (error) {
        console.error('AI ç”Ÿæˆå¤±æ•—:', error);
        displayStory('AI æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦...');
      }

      // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
      buttons.forEach(btn => btn.disabled = false);
      hideTypingIndicator();
    }

    // é¡¯ç¤ºè¼¸å…¥æŒ‡ç¤ºå™¨
    function showTypingIndicator() {
      const storyArea = document.getElementById('storyText');
      storyArea.innerHTML += '<div class="typing-indicator"><div class="loading"></div>AI æ­£åœ¨æ€è€ƒ...</div>';
    }

    // éš±è—è¼¸å…¥æŒ‡ç¤ºå™¨
    function hideTypingIndicator() {
      const indicator = document.querySelector('.typing-indicator');
      if (indicator) {
        indicator.remove();
      }
    }

    // ç”Ÿæˆæ•…äº‹å…§å®¹ï¼ˆæ¨¡æ“¬ AI éŸ¿æ‡‰ï¼‰
    async function generateStory(choice) {
      // æ¨¡æ“¬ API èª¿ç”¨å»¶é²
      await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 2000));

      const stories = {
        attack: [
          "ä½ æ±ºå®šä¸»å‹•å‡ºæ“Šï¼æ‚„æ‚„åœ°ç¹åˆ°æ•µäººå´ç¿¼ï¼Œèˆ‰èµ· AK-47 ç„æº–ç›®æ¨™ã€‚ä¸€é™£æ¿€çƒˆçš„äº¤ç«å¾Œï¼Œä½ æˆåŠŸæ“Šæ•—äº†å°æ‰‹ï¼Œä½†ä¹Ÿæš´éœ²äº†è‡ªå·±çš„ä½ç½®ã€‚é è™•å‚³ä¾†æ›´å¤šè…³æ­¥è²...",
          "ä½ çªç„¶è¡å‡ºæ©è­·ç™¼å‹•æ”»æ“Šï¼é›–ç„¶æ‰“ä¸­äº†æ•µäººï¼Œä½†å°æ–¹ä¹ŸåŠæ™‚åæ“Šã€‚é›™æ–¹åœ¨å»¢æ£„çš„æ©Ÿæ¢°é–“å±•é–‹æ¿€çƒˆæ§æˆ°ï¼Œç«èŠ±å››æ¿ºã€‚æœ€çµ‚ä½ ç²å¾—å‹åˆ©ï¼Œä½†æ¶ˆè€—äº†ä¸å°‘å½ˆè—¥ã€‚"
        ],
        stealth: [
          "ä½ é¸æ“‡ä¿æŒéš±è—ï¼Œéœéœè§€å¯Ÿè‘—æ•µäººçš„ä¸€èˆ‰ä¸€å‹•ã€‚é€éç ´ç¢çš„çª—æˆ¶ï¼Œä½ ç™¼ç¾å°æ–¹ä¼¼ä¹åœ¨å°‹æ‰¾ä»€éº¼æ±è¥¿ã€‚çªç„¶ï¼Œæ¯’åœˆé–‹å§‹æ”¶ç¸®çš„è­¦å‘ŠéŸ¿èµ·...",
          "ä½ è¹²ä¼åœ¨é™°å½±ä¸­ï¼Œå±æ¯å‡ç¥åœ°è§€å¯Ÿè‘—ã€‚æ•µäººä¼¼ä¹æ²’æœ‰ç™¼ç¾ä½ ï¼Œæ­£å°ˆæ³¨åœ°æœå°‹è‘—ç‰©è³‡ã€‚é€™çµ¦äº†ä½ ä¸€å€‹æ©Ÿæœƒï¼Œæˆ–è¨±ä½ èƒ½æ‰¾åˆ°æ›´å¥½çš„æ™‚æ©Ÿè¡Œå‹•ã€‚"
        ],
        retreat: [
          "æ˜æ™ºçš„é¸æ“‡ï¼ä½ æ‚„æ‚„åœ°å‘å¾Œæ’¤é€€ï¼Œé¿é–‹äº†é€™å ´å¯èƒ½çš„è¡çªã€‚ç¹é“è€Œè¡Œæ™‚ï¼Œä½ ç™¼ç¾äº†ä¸€å€‹éš±ç§˜çš„ç‰©è³‡é»ï¼Œè£¡é¢æœ‰ä½ æ€¥éœ€çš„é†«ç™‚åŒ…å’Œå½ˆè—¥ã€‚",
          "ä½ å°å¿ƒç¿¼ç¿¼åœ°æ’¤é›¢ç¾å ´ï¼Œé¸æ“‡äº†ä¸€æ¢è¼ƒç‚ºå®‰å…¨çš„è·¯ç·šã€‚é›–ç„¶éŒ¯éäº†å¯èƒ½çš„æˆ°åˆ©å“ï¼Œä½†ä¿å­˜äº†é«”åŠ›å’Œå½ˆè—¥ã€‚å‰æ–¹å‡ºç¾äº†æ–°çš„å»ºç¯‰ç¾¤..."
        ],
        explore: [
          "ä½ é¼“èµ·å‹‡æ°£ï¼Œæ”¾ä¸‹æ­¦å™¨å‘å°æ–¹å–Šè©±ã€‚å‡ºä¹æ„æ–™çš„æ˜¯ï¼Œå°æ–¹ä¹Ÿåœæ­¢äº†æœç´¢ï¼Œä¼¼ä¹é¡˜æ„äº¤æµã€‚ä½ å€‘æš«æ™‚çµæˆäº†è¯ç›Ÿï¼Œæ±ºå®šä¸€èµ·é¢å°æ¥ä¸‹ä¾†çš„æŒ‘æˆ°ã€‚",
          "ä½ å˜—è©¦èˆ‡å°æ–¹å»ºç«‹è¯çµ¡ï¼Œä½†å°æ–¹ä¼¼ä¹éå¸¸è¬¹æ…ã€‚ç¶“éä¸€ç•ªç·Šå¼µçš„å°è©±å¾Œï¼Œä½ å€‘é”æˆäº†æš«æ™‚çš„ä¼‘æˆ°å”è­°ï¼Œä¸¦åˆ†äº«äº†ä¸€äº›æœ‰ç”¨çš„æƒ…å ±ã€‚"
        ]
      };

      const storyOptions = stories[choice] || ["æœªçŸ¥çš„é¸æ“‡å°è‡´äº†æ„å¤–çš„çµæœ..."];
      return storyOptions[Math.floor(Math.random() * storyOptions.length)];
    }

    // æ ¹æ“šé¸æ“‡æ›´æ–°éŠæˆ²ç‹€æ…‹
    function updateGameStateFromChoice(choice) {
      switch (choice) {
        case 'attack':
          gameState.health -= Math.floor(Math.random() * 15) + 5; // 5-20 å‚·å®³
          gameState.survivors -= Math.floor(Math.random() * 3) + 1; // æ¸›å°‘1-3äºº
          break;
        case 'stealth':
          // æ½›è¡Œé€šå¸¸è¼ƒå®‰å…¨ï¼Œä½†å¯èƒ½æ¶ˆè€—æ™‚é–“
          if (Math.random() < 0.3) {
            gameState.health -= Math.floor(Math.random() * 5) + 1;
          }
          break;
        case 'retreat':
          // æ’¤é€€è¼ƒå®‰å…¨ï¼Œå¯èƒ½æ¢å¾©ä¸€äº›ç”Ÿå‘½å€¼
          if (Math.random() < 0.4) {
            gameState.health = Math.min(gameState.maxHealth, gameState.health + 10);
          }
          break;
        case 'explore':
          // æ¢ç´¢æœ‰é¢¨éšªä½†å¯èƒ½æœ‰æ”¶ç©«
          if (Math.random() < 0.5) {
            gameState.health -= Math.floor(Math.random() * 10) + 1;
          } else {
            gameState.health = Math.min(gameState.maxHealth, gameState.health + 5);
          }
          break;
      }

      // ç¢ºä¿æ•¸å€¼åœ¨åˆç†ç¯„åœå…§
      gameState.health = Math.max(0, Math.min(gameState.maxHealth, gameState.health));
      gameState.survivors = Math.max(1, gameState.survivors);

      updateGameStatus();
    }

    // é¡¯ç¤ºæ–°æ•…äº‹
    function displayStory(story) {
      const storyText = document.getElementById('storyText');
      storyText.innerHTML = story + '<br><br>';

      // ç”Ÿæˆæ–°çš„é¸æ“‡
      generateNewChoices();
    }

    // ç”Ÿæˆæ–°é¸æ“‡
    function generateNewChoices() {
      const choiceTypes = [
        { type: 'attack', icon: 'âš”ï¸', title: 'ä¸»å‹•æ”»æ“Š', desc: 'ç™¼å‹•çªè¥²æ”»æ“Šé™„è¿‘çš„æ•µäºº' },
        { type: 'stealth', icon: 'ğŸ‘ï¸', title: 'æš—ä¸­è§€å¯Ÿ', desc: 'ä¿æŒéš±è—ä¸¦æ”¶é›†æƒ…å ±' },
        { type: 'retreat', icon: 'ğŸƒ', title: 'æˆ°è¡“æ’¤é€€', desc: 'å°‹æ‰¾æ›´å®‰å…¨çš„ä½ç½®' },
        { type: 'explore', icon: 'ğŸ”', title: 'æœç´¢ç‰©è³‡', desc: 'åœ¨é™„è¿‘å°‹æ‰¾æœ‰ç”¨çš„è£å‚™' }
      ];

      // éš¨æ©Ÿé¸æ“‡4å€‹ä¸åŒçš„é¸é …
      const shuffled = [...choiceTypes].sort(() => 0.5 - Math.random());
      const choicesArea = document.getElementById('choicesArea');

      choicesArea.innerHTML = '';

      shuffled.forEach(choice => {
        const button = document.createElement('button');
        button.className = `choice-btn ${choice.type}`;
        button.onclick = () => makeChoice(choice.type);
        button.innerHTML = `
                    <div class="choice-icon">${choice.icon}</div>
                    <div class="choice-content">
                        <h3>${choice.title}</h3>
                        <p>${choice.desc}</p>
                    </div>
                `;
        choicesArea.appendChild(button);
      });
    }

    // ç²å–é¸æ“‡æ—¥èªŒæ–‡æœ¬
    function getChoiceLogText(choice) {
      const logTexts = {
        attack: 'ç™¼å‹•æ”»æ“Šï¼Œèˆ‡æ•µäººäº¤æˆ°',
        stealth: 'é¸æ“‡æ½›è¡Œï¼Œä¿æŒéš±è—',
        retreat: 'æˆ°è¡“æ’¤é€€ï¼Œå°‹æ‰¾å®‰å…¨ä½ç½®',
        explore: 'æœç´¢å€åŸŸï¼Œå°‹æ‰¾ç‰©è³‡'
      };
      return logTexts[choice] || 'åŸ·è¡Œäº†æœªçŸ¥å‹•ä½œ';
    }

    // æ·»åŠ æ—¥èªŒæ¢ç›®
    function addLogEntry(type, message) {
      const logEntries = document.getElementById('logEntries');
      const entry = document.createElement('div');
      entry.className = 'log-entry';

      const currentTime = new Date();
      const timeStr = `${currentTime.getMinutes()}:${currentTime.getSeconds().toString().padStart(2, '0')}`;

      const icons = {
        success: 'âœ“',
        danger: 'âœ—',
        info: 'â„¹'
      };

      entry.innerHTML = `
                <div class="log-icon ${type}">${icons[type] || 'â„¹'}</div>
                <span class="log-time">${timeStr}</span>
                <span>${message}</span>
            `;

      logEntries.insertBefore(entry, logEntries.firstChild);

      // ä¿æŒæœ€å¤š10æ¢è¨˜éŒ„
      while (logEntries.children.length > 10) {
        logEntries.removeChild(logEntries.lastChild);
      }
    }

    // éŠæˆ²çµæŸ
    function endGame(reason) {
      gameState.isGameOver = true;

      const gameOverDiv = document.createElement('div');
      gameOverDiv.className = 'game-over';

      let title, message, color;
      if (reason === 'å‹åˆ©') {
        title = 'ğŸ† å¤§å‰å¤§åˆ©ï¼Œä»Šæ™šåƒé›ï¼';
        message = 'æ­å–œä½ åœ¨é€™å ´å¤§é€ƒæ®ºä¸­ç²å¾—å‹åˆ©ï¼';
        color = '#4caf50';
      } else {
        title = 'ğŸ’€ éŠæˆ²çµæŸ';
        message = `ä½ åœ¨é€™å ´å¤§é€ƒæ®ºä¸­${reason}ï¼Œä¸‹æ¬¡å†ä¾†æŒ‘æˆ°å§ï¼`;
        color = '#ff6b6b';
      }

      gameOverDiv.innerHTML = `
                <div class="game-over-content">
                    <h2 style="color: ${color}">${title}</h2>
                    <p>${message}</p>
                    <p>å­˜æ´»æ™‚é–“: ${Math.floor(gameState.gameTime / 60)}åˆ†${gameState.gameTime % 60}ç§’</p>
                    <p>æœ€çµ‚æ’å: ${reason === 'å‹åˆ©' ? 'ç¬¬1å' : `ç¬¬${gameState.survivors + 1}å`}</p>
                    <button class="restart-btn" onclick="restartGame()">ğŸ”„ é‡æ–°é–‹å§‹</button>
                </div>
            `;

      document.body.appendChild(gameOverDiv);
    }

    // é‡æ–°é–‹å§‹éŠæˆ²
    function restartGame() {
      // é‡ç½®éŠæˆ²ç‹€æ…‹
      gameState = {
        survivors: Math.floor(Math.random() * 20) + 80, // 80-99
        maxSurvivors: 100,
        health: 100,
        maxHealth: 100,
        gameTime: 0,
        safeZoneTime: 180,
        location: 'å»¢æ£„å·¥å» ',
        inventory: ['AK-47', 'é˜²å½ˆè¡£', 'é†«ç™‚åŒ…'],
        isConnected: gameState.isConnected,
        isGameOver: false
      };

      // ç§»é™¤éŠæˆ²çµæŸç•«é¢
      const gameOverDiv = document.querySelector('.game-over');
      if (gameOverDiv) {
        gameOverDiv.remove();
      }

      // é‡ç½®æ•…äº‹å’Œé¸æ“‡
      const initialStory = "æ–°çš„ä¸€å±€é–‹å§‹äº†ï¼ä½ é™è½åœ¨å»¢æ£„å·¥å» é™„è¿‘ï¼Œå‘¨åœå‚³ä¾†å…¶ä»–ç©å®¶çš„å‹•éœã€‚ä½ å¿…é ˆå¿«é€Ÿè¡Œå‹•ï¼Œæ”¶é›†è£å‚™ä¸¦åˆ¶å®šç”Ÿå­˜ç­–ç•¥ã€‚æ¯’åœˆå³å°‡é–‹å§‹æ”¶ç¸®ï¼Œæ™‚é–“ä¸å¤šäº†...";
      displayStory(initialStory);

      // æ¸…ç©ºæ—¥èªŒ
      const logEntries = document.getElementById('logEntries');
      logEntries.innerHTML = `
                <div class="log-entry">
                    <div class="log-icon info">â„¹</div>
                    <span class="log-time">00:00</span>
                    <span>éŠæˆ²é–‹å§‹ï¼Œç¥ä½ å¥½é‹ï¼</span>
                </div>
            `;

      updateGameStatus();
    }

    // çœŸå¯¦çš„ AI API èª¿ç”¨ï¼ˆç•¶æœ‰çœŸå¯¦ API æ™‚ä½¿ç”¨ï¼‰
    async function callAIAPI(prompt) {
      const response = await fetch(`${apiConfig.url}/api/generate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(apiConfig.key && { 'Authorization': `Bearer ${apiConfig.key}` })
        },
        body: JSON.stringify({
          model: apiConfig.model,
          prompt: `ä½ æ˜¯ä¸€å€‹å¤§é€ƒæ®ºéŠæˆ²çš„AIæ•˜è¿°è€…ã€‚æ ¹æ“šç©å®¶çš„é¸æ“‡"${prompt}"ï¼Œå‰µé€ ä¸€å€‹ç·Šå¼µåˆºæ¿€çš„æ•…äº‹æƒ…ç¯€ã€‚æ•…äº‹æ‡‰è©²ï¼š
                    1. æè¿°å‹•ä½œçš„çµæœå’Œå¾Œæœ
                    2. ç‡Ÿé€ ç·Šå¼µæ°›åœ
                    3. ç‚ºä¸‹ä¸€å€‹é¸æ“‡åšé‹ªå¢Š
                    4. ä¿æŒ200å­—ä»¥å…§
                    
                    è«‹ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸¦ä¿æŒéŠæˆ²çš„åˆºæ¿€æ„Ÿã€‚`,
          stream: false
        })
      });

      const data = await response.json();
      return data.response || "AI ç„¡æ³•ç”Ÿæˆå›æ‡‰";
    }

    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      initGame();
      updateConnectionStatus();

      // åˆå§‹åŒ–é¸æ“‡æŒ‰éˆ•
      generateNewChoices();

      // æ·»åŠ éµç›¤å¿«æ·éµ
      document.addEventListener('keydown', function (e) {
        if (!gameState.isGameOver) {
          switch (e.key) {
            case '1': makeChoice('attack'); break;
            case '2': makeChoice('stealth'); break;
            case '3': makeChoice('retreat'); break;
            case '4': makeChoice('explore'); break;
          }
        }
      });
    });

    // æ·»åŠ ç‰©å“é»æ“Šäº‹ä»¶
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('inventory-item') && e.target.classList.contains('has-item')) {
        const item = e.target.title;
        if (item === 'é†«ç™‚åŒ…' && gameState.health < gameState.maxHealth) {
          gameState.health = Math.min(gameState.maxHealth, gameState.health + 30);
          updateGameStatus();
          addLogEntry('success', 'ä½¿ç”¨é†«ç™‚åŒ…ï¼Œç”Ÿå‘½å€¼æ¢å¾©');
          e.target.classList.remove('has-item');
          e.target.innerHTML = '';
          e.target.title = 'ç©ºæ ¼';
        }
      }
    });

    // å®šæœŸæ›´æ–°ä½ç½®
    setInterval(() => {
      const locations = ['å»¢æ£„å·¥å» ', 'ç ´èˆŠå­¸æ ¡', 'è’æ¶¼è¾²å ´', 'å»¢æ£„é†«é™¢', 'è»äº‹åŸºåœ°', 'å°é®ä¸­å¿ƒ'];
      if (Math.random() < 0.1) { // 10% æ©Ÿç‡æ”¹è®Šä½ç½®
        const newLocation = locations[Math.floor(Math.random() * locations.length)];
        if (newLocation !== gameState.location) {
          gameState.location = newLocation;
          document.querySelector('.location').innerHTML = `ğŸ“ ä½ç½®ï¼š${newLocation}`;
          addLogEntry('info', `ç§»å‹•åˆ°äº†${newLocation}`);
        }
      }
    }, 15000); // æ¯15ç§’æª¢æŸ¥ä¸€æ¬¡

  </script>
</body>

</html>
