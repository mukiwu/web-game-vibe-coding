<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI 大逃殺</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    /* 左側面板 */
    .sidebar {
      width: 320px;
      background: rgba(26, 26, 46, 0.95);
      border-right: 1px solid #333;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .logo {
      color: #ff6b6b;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 30px;
    }

    .logo::before {
      content: "🎮";
      margin-right: 10px;
    }

    .section-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #fff;
    }

    .ai-config {
      margin-bottom: 30px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #ccc;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      background: #2d2d44;
      border: 1px solid #444;
      border-radius: 5px;
      color: white;
      font-size: 14px;
    }

    .test-btn {
      width: 100%;
      padding: 12px;
      background: #ff6b6b;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .test-btn:hover {
      background: #ff5252;
    }

    .test-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    /* 遊戲狀態 */
    .game-status {
      margin-bottom: 30px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .status-value {
      font-weight: bold;
    }

    .status-value.survivors {
      color: #ff6b6b;
    }

    .status-value.area {
      color: #ffa726;
    }

    .status-value.time {
      color: #66bb6a;
    }

    .status-value.health {
      color: #4caf50;
    }

    .health-bar {
      width: 100%;
      height: 8px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .health-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      transition: width 0.5s ease;
    }

    /* 背包物品 */
    .inventory {
      margin-top: auto;
    }

    .inventory-items {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .inventory-item {
      aspect-ratio: 1;
      background: #2d2d44;
      border: 2px solid #444;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .inventory-item.has-item {
      border-color: #ff6b6b;
      background: #3d2d44;
    }

    .inventory-item:hover {
      border-color: #66bb6a;
    }

    /* 主要遊戲區域 */
    .main-area {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .location {
      display: flex;
      align-items: center;
      color: #ff6b6b;
    }

    .countdown {
      display: flex;
      align-items: center;
      color: #ffa726;
    }

    .ai-status {
      color: #4caf50;
    }

    /* AI 敘述區 */
    .story-area {
      background: rgba(45, 45, 68, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      min-height: 200px;
      flex-grow: 1;
    }

    .ai-narrator {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .ai-avatar {
      width: 40px;
      height: 40px;
      background: #ff6b6b;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 18px;
    }

    .ai-message {
      flex: 1;
      line-height: 1.6;
    }

    .ai-name {
      font-weight: bold;
      color: #ff6b6b;
      margin-bottom: 5px;
    }

    .story-text {
      margin-bottom: 20px;
    }

    .choices-prompt {
      color: #ffa726;
      font-weight: bold;
      margin-bottom: 15px;
    }

    /* 選擇按鈕 */
    .choices-area {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .choice-btn {
      padding: 20px;
      background: rgba(45, 45, 68, 0.8);
      border: 2px solid #444;
      border-radius: 15px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      display: flex;
      align-items: center;
    }

    .choice-btn:hover {
      border-color: #66bb6a;
      background: rgba(66, 66, 88, 0.9);
    }

    .choice-btn.attack {
      border-color: #ff6b6b;
    }

    .choice-btn.stealth {
      border-color: #2196f3;
    }

    .choice-btn.retreat {
      border-color: #4caf50;
    }

    .choice-btn.explore {
      border-color: #ffa726;
    }

    .choice-btn:hover.attack {
      border-color: #ff8a80;
      background: rgba(255, 107, 107, 0.1);
    }

    .choice-btn:hover.stealth {
      border-color: #90caf9;
      background: rgba(33, 150, 243, 0.1);
    }

    .choice-btn:hover.retreat {
      border-color: #a5d6a7;
      background: rgba(76, 175, 80, 0.1);
    }

    .choice-btn:hover.explore {
      border-color: #ffcc02;
      background: rgba(255, 167, 38, 0.1);
    }

    .choice-icon {
      font-size: 24px;
      margin-right: 15px;
    }

    .choice-content h3 {
      margin-bottom: 5px;
      font-size: 16px;
    }

    .choice-content p {
      font-size: 14px;
      color: #ccc;
      line-height: 1.4;
    }

    /* 遊戲記錄 */
    .game-log {
      background: rgba(45, 45, 68, 0.6);
      border-radius: 10px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-title {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .log-entry {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 5px 0;
      font-size: 14px;
    }

    .log-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .log-icon.success {
      background: #4caf50;
    }

    .log-icon.danger {
      background: #ff6b6b;
    }

    .log-icon.info {
      background: #2196f3;
    }

    .log-time {
      color: #888;
      margin-right: 10px;
    }

    /* Loading 動畫 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #333;
      border-radius: 50%;
      border-top-color: #ff6b6b;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      color: #888;
      font-style: italic;
    }

    /* 響應式設計 */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #333;
      }

      .choices-area {
        grid-template-columns: 1fr;
      }
    }

    /* 遊戲結束畫面 */
    .game-over {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .game-over-content {
      background: #1a1a2e;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      border: 2px solid #ff6b6b;
    }

    .game-over h2 {
      color: #ff6b6b;
      margin-bottom: 20px;
      font-size: 32px;
    }

    .restart-btn {
      padding: 15px 30px;
      background: #4caf50;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }

    .restart-btn:hover {
      background: #45a049;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 左側面板 -->
    <div class="sidebar">
      <div class="logo">AI 大逃殺</div>

      <!-- AI 模型設定 -->
      <div class="ai-config">
        <h3 class="section-title">AI 模型設定</h3>
        <div class="input-group">
          <label>Ollama API URL</label>
          <input type="text" id="apiUrl" value="http://localhost:11434" placeholder="API URL">
        </div>
        <div class="input-group">
          <label>API Key</label>
          <input type="password" id="apiKey" placeholder="輸入 API Key（選填）">
        </div>
        <div class="input-group">
          <label>模型名稱</label>
          <input type="text" id="modelName" value="llama3.2:7b" placeholder="例如：llama3.2:7b">
        </div>
        <button class="test-btn" onclick="testConnection()">🔗 測試連接</button>
      </div>

      <!-- 遊戲狀態 -->
      <div class="game-status">
        <h3 class="section-title">遊戲狀態</h3>
        <div class="status-item">
          <span>存活人數</span>
          <span class="status-value survivors" id="survivors">42/100</span>
        </div>
        <div class="status-item">
          <span>安全區域</span>
          <span class="status-value area" id="safeZone">縮小中</span>
        </div>
        <div class="status-item">
          <span>遊戲時間</span>
          <span class="status-value time" id="gameTime">12:34</span>
        </div>
        <div class="status-item">
          <span>生命值</span>
          <span class="status-value health" id="healthValue">85/100</span>
        </div>
        <div class="health-bar">
          <div class="health-fill" id="healthBar" style="width: 85%"></div>
        </div>
      </div>

      <!-- 背包物品 -->
      <div class="inventory">
        <h3 class="section-title">背包物品</h3>
        <div class="inventory-items">
          <div class="inventory-item has-item" title="AK-47">🔫</div>
          <div class="inventory-item has-item" title="防彈衣">🛡️</div>
          <div class="inventory-item has-item" title="醫療包">🏥</div>
          <div class="inventory-item" title="空格"></div>
        </div>
      </div>
    </div>

    <!-- 主要遊戲區域 -->
    <div class="main-area">
      <!-- 遊戲標題 -->
      <div class="game-header">
        <div class="location">📍 位置：廢棄工廠</div>
        <div class="countdown">⏱️ 毒圈縮小：2:15</div>
        <div class="ai-status" id="connectionStatus">🟢 AI 已連接</div>
      </div>

      <!-- AI 敘述區域 -->
      <div class="story-area">
        <div class="ai-narrator">
          <div class="ai-avatar">🤖</div>
          <div class="ai-message">
            <div class="ai-name">AI 敘述者 剛剛</div>
            <div class="story-text" id="storyText">
              你小心翼翼地潛行在廢棄工廠的陰影中，遠處傳來槍聲和爆炸聲。突然，你聽到腳步聲從側翼傳來，似乎有其他玩家正在接近你的位置。
              <br><br>
              你的心跳加速，手緊握著 AK-47，透過破碎的窗戶，你看到一個身影正在小心地搜索附近的建築物。毒圈正在縮小，你必須做出決定...
            </div>
            <div class="choices-prompt">你現在有以下選擇：</div>
          </div>
        </div>
      </div>

      <!-- 選擇按鈕區域 -->
      <div class="choices-area" id="choicesArea">
        <button class="choice-btn attack" onclick="makeChoice('attack')">
          <div class="choice-icon">⚔️</div>
          <div class="choice-content">
            <h3>主動攻擊</h3>
            <p>趁對方不注意發動突襲，試圖消滅威脅</p>
          </div>
        </button>
        <button class="choice-btn stealth" onclick="makeChoice('stealth')">
          <div class="choice-icon">👁️</div>
          <div class="choice-content">
            <h3>暗中觀察</h3>
            <p>保持隱藏，觀察對方的行動並等待時機</p>
          </div>
        </button>
        <button class="choice-btn retreat" onclick="makeChoice('retreat')">
          <div class="choice-icon">🏃</div>
          <div class="choice-content">
            <h3>悄悄撤退</h3>
            <p>避免衝突，尋找其他路線繼續前進</p>
          </div>
        </button>
        <button class="choice-btn explore" onclick="makeChoice('explore')">
          <div class="choice-icon">🔍</div>
          <div class="choice-content">
            <h3>實驗溝通</h3>
            <p>冒險嘗試與對方建立聯盟關係</p>
          </div>
        </button>
      </div>

      <!-- 遊戲記錄 -->
      <div class="game-log">
        <div class="log-title">
          <span>🕐 遊戲記錄</span>
        </div>
        <div id="logEntries">
          <div class="log-entry">
            <div class="log-icon success">✓</div>
            <span class="log-time">12:30</span>
            <span>成功找到防彈衣，防護力提升</span>
          </div>
          <div class="log-entry">
            <div class="log-icon danger">✗</div>
            <span class="log-time">12:25</span>
            <span>與敵人交火，消耗了大量彈藥</span>
          </div>
          <div class="log-entry">
            <div class="log-icon info">ℹ</div>
            <span class="log-time">12:20</span>
            <span>發現醫療包，生命值完全恢復</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 遊戲狀態
    let gameState = {
      survivors: 42,
      maxSurvivors: 100,
      health: 85,
      maxHealth: 100,
      gameTime: 754, // 秒
      safeZoneTime: 135, // 毒圈縮小倒計時
      location: '廢棄工廠',
      inventory: ['AK-47', '防彈衣', '醫療包'],
      isConnected: false,
      isGameOver: false
    };

    // API 設定
    let apiConfig = {
      url: 'http://localhost:11434',
      key: '',
      model: 'llama3.2:7b'
    };

    // 遊戲初始化
    function initGame() {
      updateGameStatus();
      startGameTimer();
      loadApiConfig();
    }

    // 載入 API 設定
    function loadApiConfig() {
      const savedUrl = localStorage.getItem('apiUrl');
      const savedKey = localStorage.getItem('apiKey');
      const savedModel = localStorage.getItem('modelName');

      if (savedUrl) document.getElementById('apiUrl').value = savedUrl;
      if (savedKey) document.getElementById('apiKey').value = savedKey;
      if (savedModel) document.getElementById('modelName').value = savedModel;
    }

    // 測試 API 連接
    async function testConnection() {
      const apiUrl = document.getElementById('apiUrl').value;
      const apiKey = document.getElementById('apiKey').value;
      const modelName = document.getElementById('modelName').value;

      const testBtn = document.querySelector('.test-btn');
      testBtn.disabled = true;
      testBtn.innerHTML = '<div class="loading"></div>測試中...';

      try {
        // 儲存設定
        apiConfig = { url: apiUrl, key: apiKey, model: modelName };
        localStorage.setItem('apiUrl', apiUrl);
        localStorage.setItem('apiKey', apiKey);
        localStorage.setItem('modelName', modelName);

        // 測試連接（這裡使用模擬測試）
        await new Promise(resolve => setTimeout(resolve, 2000));

        gameState.isConnected = true;
        updateConnectionStatus();
        testBtn.innerHTML = '✅ 連接成功';
        testBtn.style.background = '#4caf50';

        setTimeout(() => {
          testBtn.innerHTML = '🔗 測試連接';
          testBtn.style.background = '#ff6b6b';
          testBtn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('連接測試失敗:', error);
        testBtn.innerHTML = '❌ 連接失敗';
        testBtn.style.background = '#f44336';

        setTimeout(() => {
          testBtn.innerHTML = '🔗 測試連接';
          testBtn.style.background = '#ff6b6b';
          testBtn.disabled = false;
        }, 2000);
      }
    }

    // 更新連接狀態
    function updateConnectionStatus() {
      const status = document.getElementById('connectionStatus');
      if (gameState.isConnected) {
        status.innerHTML = '🟢 AI 已連接';
        status.className = 'ai-status';
      } else {
        status.innerHTML = '🔴 AI 未連接';
        status.className = 'ai-status disconnected';
      }
    }

    // 更新遊戲狀態顯示
    function updateGameStatus() {
      document.getElementById('survivors').textContent = `${gameState.survivors}/${gameState.maxSurvivors}`;
      document.getElementById('healthValue').textContent = `${gameState.health}/${gameState.maxHealth}`;
      document.getElementById('healthBar').style.width = `${(gameState.health / gameState.maxHealth) * 100}%`;

      // 更新時間
      const minutes = Math.floor(gameState.gameTime / 60);
      const seconds = gameState.gameTime % 60;
      document.getElementById('gameTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      // 更新毒圈倒計時
      const zoneMinutes = Math.floor(gameState.safeZoneTime / 60);
      const zoneSeconds = gameState.safeZoneTime % 60;
      document.querySelector('.countdown').innerHTML = `⏱️ 毒圈縮小：${zoneMinutes}:${zoneSeconds.toString().padStart(2, '0')}`;
    }

    // 開始遊戲計時器
    function startGameTimer() {
      setInterval(() => {
        if (!gameState.isGameOver) {
          gameState.gameTime++;
          gameState.safeZoneTime--;

          if (gameState.safeZoneTime <= 0) {
            gameState.safeZoneTime = 180; // 重置為3分鐘
            gameState.health -= 10; // 毒圈傷害
            addLogEntry('danger', '毒圈傷害！生命值下降');
          }

          // 隨機事件
          if (Math.random() < 0.01) { // 1% 機率
            gameState.survivors--;
            addLogEntry('info', '有玩家被淘汰');
          }

          updateGameStatus();

          if (gameState.health <= 0) {
            endGame('死亡');
          } else if (gameState.survivors <= 1) {
            endGame('勝利');
          }
        }
      }, 1000);
    }

    // 玩家選擇
    async function makeChoice(choice) {
      if (!gameState.isConnected) {
        alert('請先測試連接 AI 模型！');
        return;
      }

      // 禁用所有選擇按鈕
      const buttons = document.querySelectorAll('.choice-btn');
      buttons.forEach(btn => btn.disabled = true);

      // 顯示載入狀態
      showTypingIndicator();

      try {
        // 生成新的故事內容
        const newStory = await generateStory(choice);

        // 更新遊戲狀態
        updateGameStateFromChoice(choice);

        // 顯示新故事
        displayStory(newStory);

        // 記錄選擇
        addLogEntry('info', getChoiceLogText(choice));

      } catch (error) {
        console.error('AI 生成失敗:', error);
        displayStory('AI 暫時無法回應，請稍後再試...');
      }

      // 重新啟用按鈕
      buttons.forEach(btn => btn.disabled = false);
      hideTypingIndicator();
    }

    // 顯示輸入指示器
    function showTypingIndicator() {
      const storyArea = document.getElementById('storyText');
      storyArea.innerHTML += '<div class="typing-indicator"><div class="loading"></div>AI 正在思考...</div>';
    }

    // 隱藏輸入指示器
    function hideTypingIndicator() {
      const indicator = document.querySelector('.typing-indicator');
      if (indicator) {
        indicator.remove();
      }
    }

    // 生成故事內容（模擬 AI 響應）
    async function generateStory(choice) {
      // 模擬 API 調用延遲
      await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 2000));

      const stories = {
        attack: [
          "你決定主動出擊！悄悄地繞到敵人側翼，舉起 AK-47 瞄準目標。一陣激烈的交火後，你成功擊敗了對手，但也暴露了自己的位置。遠處傳來更多腳步聲...",
          "你突然衝出掩護發動攻擊！雖然打中了敵人，但對方也及時反擊。雙方在廢棄的機械間展開激烈槍戰，火花四濺。最終你獲得勝利，但消耗了不少彈藥。"
        ],
        stealth: [
          "你選擇保持隱藏，靜靜觀察著敵人的一舉一動。透過破碎的窗戶，你發現對方似乎在尋找什麼東西。突然，毒圈開始收縮的警告響起...",
          "你蹲伏在陰影中，屏息凝神地觀察著。敵人似乎沒有發現你，正專注地搜尋著物資。這給了你一個機會，或許你能找到更好的時機行動。"
        ],
        retreat: [
          "明智的選擇！你悄悄地向後撤退，避開了這場可能的衝突。繞道而行時，你發現了一個隱秘的物資點，裡面有你急需的醫療包和彈藥。",
          "你小心翼翼地撤離現場，選擇了一條較為安全的路線。雖然錯過了可能的戰利品，但保存了體力和彈藥。前方出現了新的建築群..."
        ],
        explore: [
          "你鼓起勇氣，放下武器向對方喊話。出乎意料的是，對方也停止了搜索，似乎願意交流。你們暫時結成了聯盟，決定一起面對接下來的挑戰。",
          "你嘗試與對方建立聯絡，但對方似乎非常謹慎。經過一番緊張的對話後，你們達成了暫時的休戰協議，並分享了一些有用的情報。"
        ]
      };

      const storyOptions = stories[choice] || ["未知的選擇導致了意外的結果..."];
      return storyOptions[Math.floor(Math.random() * storyOptions.length)];
    }

    // 根據選擇更新遊戲狀態
    function updateGameStateFromChoice(choice) {
      switch (choice) {
        case 'attack':
          gameState.health -= Math.floor(Math.random() * 15) + 5; // 5-20 傷害
          gameState.survivors -= Math.floor(Math.random() * 3) + 1; // 減少1-3人
          break;
        case 'stealth':
          // 潛行通常較安全，但可能消耗時間
          if (Math.random() < 0.3) {
            gameState.health -= Math.floor(Math.random() * 5) + 1;
          }
          break;
        case 'retreat':
          // 撤退較安全，可能恢復一些生命值
          if (Math.random() < 0.4) {
            gameState.health = Math.min(gameState.maxHealth, gameState.health + 10);
          }
          break;
        case 'explore':
          // 探索有風險但可能有收穫
          if (Math.random() < 0.5) {
            gameState.health -= Math.floor(Math.random() * 10) + 1;
          } else {
            gameState.health = Math.min(gameState.maxHealth, gameState.health + 5);
          }
          break;
      }

      // 確保數值在合理範圍內
      gameState.health = Math.max(0, Math.min(gameState.maxHealth, gameState.health));
      gameState.survivors = Math.max(1, gameState.survivors);

      updateGameStatus();
    }

    // 顯示新故事
    function displayStory(story) {
      const storyText = document.getElementById('storyText');
      storyText.innerHTML = story + '<br><br>';

      // 生成新的選擇
      generateNewChoices();
    }

    // 生成新選擇
    function generateNewChoices() {
      const choiceTypes = [
        { type: 'attack', icon: '⚔️', title: '主動攻擊', desc: '發動突襲攻擊附近的敵人' },
        { type: 'stealth', icon: '👁️', title: '暗中觀察', desc: '保持隱藏並收集情報' },
        { type: 'retreat', icon: '🏃', title: '戰術撤退', desc: '尋找更安全的位置' },
        { type: 'explore', icon: '🔍', title: '搜索物資', desc: '在附近尋找有用的裝備' }
      ];

      // 隨機選擇4個不同的選項
      const shuffled = [...choiceTypes].sort(() => 0.5 - Math.random());
      const choicesArea = document.getElementById('choicesArea');

      choicesArea.innerHTML = '';

      shuffled.forEach(choice => {
        const button = document.createElement('button');
        button.className = `choice-btn ${choice.type}`;
        button.onclick = () => makeChoice(choice.type);
        button.innerHTML = `
                    <div class="choice-icon">${choice.icon}</div>
                    <div class="choice-content">
                        <h3>${choice.title}</h3>
                        <p>${choice.desc}</p>
                    </div>
                `;
        choicesArea.appendChild(button);
      });
    }

    // 獲取選擇日誌文本
    function getChoiceLogText(choice) {
      const logTexts = {
        attack: '發動攻擊，與敵人交戰',
        stealth: '選擇潛行，保持隱藏',
        retreat: '戰術撤退，尋找安全位置',
        explore: '搜索區域，尋找物資'
      };
      return logTexts[choice] || '執行了未知動作';
    }

    // 添加日誌條目
    function addLogEntry(type, message) {
      const logEntries = document.getElementById('logEntries');
      const entry = document.createElement('div');
      entry.className = 'log-entry';

      const currentTime = new Date();
      const timeStr = `${currentTime.getMinutes()}:${currentTime.getSeconds().toString().padStart(2, '0')}`;

      const icons = {
        success: '✓',
        danger: '✗',
        info: 'ℹ'
      };

      entry.innerHTML = `
                <div class="log-icon ${type}">${icons[type] || 'ℹ'}</div>
                <span class="log-time">${timeStr}</span>
                <span>${message}</span>
            `;

      logEntries.insertBefore(entry, logEntries.firstChild);

      // 保持最多10條記錄
      while (logEntries.children.length > 10) {
        logEntries.removeChild(logEntries.lastChild);
      }
    }

    // 遊戲結束
    function endGame(reason) {
      gameState.isGameOver = true;

      const gameOverDiv = document.createElement('div');
      gameOverDiv.className = 'game-over';

      let title, message, color;
      if (reason === '勝利') {
        title = '🏆 大吉大利，今晚吃雞！';
        message = '恭喜你在這場大逃殺中獲得勝利！';
        color = '#4caf50';
      } else {
        title = '💀 遊戲結束';
        message = `你在這場大逃殺中${reason}，下次再來挑戰吧！`;
        color = '#ff6b6b';
      }

      gameOverDiv.innerHTML = `
                <div class="game-over-content">
                    <h2 style="color: ${color}">${title}</h2>
                    <p>${message}</p>
                    <p>存活時間: ${Math.floor(gameState.gameTime / 60)}分${gameState.gameTime % 60}秒</p>
                    <p>最終排名: ${reason === '勝利' ? '第1名' : `第${gameState.survivors + 1}名`}</p>
                    <button class="restart-btn" onclick="restartGame()">🔄 重新開始</button>
                </div>
            `;

      document.body.appendChild(gameOverDiv);
    }

    // 重新開始遊戲
    function restartGame() {
      // 重置遊戲狀態
      gameState = {
        survivors: Math.floor(Math.random() * 20) + 80, // 80-99
        maxSurvivors: 100,
        health: 100,
        maxHealth: 100,
        gameTime: 0,
        safeZoneTime: 180,
        location: '廢棄工廠',
        inventory: ['AK-47', '防彈衣', '醫療包'],
        isConnected: gameState.isConnected,
        isGameOver: false
      };

      // 移除遊戲結束畫面
      const gameOverDiv = document.querySelector('.game-over');
      if (gameOverDiv) {
        gameOverDiv.remove();
      }

      // 重置故事和選擇
      const initialStory = "新的一局開始了！你降落在廢棄工廠附近，周圍傳來其他玩家的動靜。你必須快速行動，收集裝備並制定生存策略。毒圈即將開始收縮，時間不多了...";
      displayStory(initialStory);

      // 清空日誌
      const logEntries = document.getElementById('logEntries');
      logEntries.innerHTML = `
                <div class="log-entry">
                    <div class="log-icon info">ℹ</div>
                    <span class="log-time">00:00</span>
                    <span>遊戲開始，祝你好運！</span>
                </div>
            `;

      updateGameStatus();
    }

    // 真實的 AI API 調用（當有真實 API 時使用）
    async function callAIAPI(prompt) {
      const response = await fetch(`${apiConfig.url}/api/generate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(apiConfig.key && { 'Authorization': `Bearer ${apiConfig.key}` })
        },
        body: JSON.stringify({
          model: apiConfig.model,
          prompt: `你是一個大逃殺遊戲的AI敘述者。根據玩家的選擇"${prompt}"，創造一個緊張刺激的故事情節。故事應該：
                    1. 描述動作的結果和後果
                    2. 營造緊張氛圍
                    3. 為下一個選擇做鋪墊
                    4. 保持200字以內
                    
                    請用繁體中文回應，並保持遊戲的刺激感。`,
          stream: false
        })
      });

      const data = await response.json();
      return data.response || "AI 無法生成回應";
    }

    // 頁面載入完成後初始化
    document.addEventListener('DOMContentLoaded', function () {
      initGame();
      updateConnectionStatus();

      // 初始化選擇按鈕
      generateNewChoices();

      // 添加鍵盤快捷鍵
      document.addEventListener('keydown', function (e) {
        if (!gameState.isGameOver) {
          switch (e.key) {
            case '1': makeChoice('attack'); break;
            case '2': makeChoice('stealth'); break;
            case '3': makeChoice('retreat'); break;
            case '4': makeChoice('explore'); break;
          }
        }
      });
    });

    // 添加物品點擊事件
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('inventory-item') && e.target.classList.contains('has-item')) {
        const item = e.target.title;
        if (item === '醫療包' && gameState.health < gameState.maxHealth) {
          gameState.health = Math.min(gameState.maxHealth, gameState.health + 30);
          updateGameStatus();
          addLogEntry('success', '使用醫療包，生命值恢復');
          e.target.classList.remove('has-item');
          e.target.innerHTML = '';
          e.target.title = '空格';
        }
      }
    });

    // 定期更新位置
    setInterval(() => {
      const locations = ['廢棄工廠', '破舊學校', '荒涼農場', '廢棄醫院', '軍事基地', '小鎮中心'];
      if (Math.random() < 0.1) { // 10% 機率改變位置
        const newLocation = locations[Math.floor(Math.random() * locations.length)];
        if (newLocation !== gameState.location) {
          gameState.location = newLocation;
          document.querySelector('.location').innerHTML = `📍 位置：${newLocation}`;
          addLogEntry('info', `移動到了${newLocation}`);
        }
      }
    }, 15000); // 每15秒檢查一次

  </script>
</body>

</html>
