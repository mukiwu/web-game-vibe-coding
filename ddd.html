<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¾èˆ‡åœ°ä¸‹åŸ AI å†’éšª</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet" />
  <style>
    :where([class^="ri-"])::before {
      content: "\f3c2";
    }

    .dice-animation {
      animation: diceRoll 0.6s ease-in-out;
    }

    @keyframes diceRoll {
      0% {
        transform: rotate(0deg) scale(1);
      }

      25% {
        transform: rotate(90deg) scale(1.1);
      }

      50% {
        transform: rotate(180deg) scale(1.2);
      }

      75% {
        transform: rotate(270deg) scale(1.1);
      }

      100% {
        transform: rotate(360deg) scale(1);
      }
    }

    .text-fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fantasy-bg {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    }

    .card-glow {
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.1);
    }

    .progress-bar {
      background: linear-gradient(90deg, #ef4444 0%, #f97316 50%, #22c55e 100%);
    }

    .loading-overlay {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #374151;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading-dots {
      display: flex;
      gap: 4px;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      background: #3b82f6;
      border-radius: 50%;
      animation: loadingDots 1.4s ease-in-out infinite both;
    }

    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    .loading-dots span:nth-child(3) {
      animation-delay: 0s;
    }

    @keyframes loadingDots {

      0%,
      80%,
      100% {
        transform: scale(0);
        opacity: 0.5;
      }

      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#3b82f6",
            secondary: "#8b5cf6",
          },
          borderRadius: {
            none: "0px",
            sm: "4px",
            DEFAULT: "8px",
            md: "12px",
            lg: "16px",
            xl: "20px",
            "2xl": "24px",
            "3xl": "32px",
            full: "9999px",
            button: "8px",
          },
        },
      },
    };
  </script>
  <script src="menu.js"></script>
</head>

<body class="fantasy-bg min-h-screen text-white">
  <!-- é ‚éƒ¨è¨­ç½®å€åŸŸ -->
  <header class="w-full bg-gray-900/50 backdrop-blur-sm border-b border-gray-700/50 px-6 py-4">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center space-x-3">
        <div
          class="w-10 h-10 flex items-center justify-center bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg">
          <i class="ri-sword-line text-white text-xl"></i>
        </div>
        <h1 class="font-['Pacifico'] text-2xl text-amber-400">
          D&D Adventure
        </h1>
      </div>

      <!-- AI è¨­ç½®å€ -->
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <label class="text-sm text-gray-300">Ollama URL:</label>
          <input type="text" id="ollamaUrl" placeholder="http://localhost:11434"
            class="bg-gray-800 border border-gray-600 rounded-button px-3 py-2 text-sm text-white w-48 focus:outline-none focus:border-primary" />
        </div>
        <div class="flex items-center space-x-2">
          <label class="text-sm text-gray-300">Ollama Model:</label>
          <div class="relative">
            <select id="modelSelect"
              class="bg-gray-800 border border-gray-600 rounded-button px-3 py-2 text-sm text-white w-48 focus:outline-none focus:border-primary appearance-none">
              <option value="">é¸æ“‡ Ollama Model</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
              <i class="ri-arrow-down-s-line text-gray-400"></i>
            </div>
          </div>
          <button id="refreshModels" type="button"
            class="bg-gray-700 hover:bg-gray-600 p-2 rounded-button text-gray-400 hover:text-white transition-colors flex items-center justify-center w-9 h-9">
            <i class="ri-refresh-line text-base"></i>
          </button>
        </div>
        <div class="flex items-center space-x-2">
          <label class="text-sm text-gray-300">API Key:</label>
          <input type="password" id="apiKey" placeholder="è¼¸å…¥æ‚¨çš„ API Key"
            class="bg-gray-800 border border-gray-600 rounded-button px-3 py-2 text-sm text-white w-48 focus:outline-none focus:border-primary" />
        </div>
        <button id="saveSettings"
          class="bg-primary hover:bg-blue-600 px-4 py-2 rounded-button text-sm font-medium transition-colors whitespace-nowrap !rounded-button">
          å„²å­˜è¨­å®š
        </button>
        <div id="connectionStatus" class="flex items-center space-x-2">
          <div id="statusIndicator" class="w-3 h-3 rounded-full bg-gray-500"></div>
          <span id="statusText" class="text-xs text-gray-400">æœªé€£æ¥</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading è¦†è“‹å±¤ -->
  <div id="loadingOverlay" class="fixed inset-0 z-50 loading-overlay hidden flex items-center justify-center">
    <div class="bg-gray-900/90 backdrop-blur-sm rounded-xl p-8 text-center border border-gray-700/50">
      <div class="loading-spinner mx-auto mb-4"></div>
      <div class="text-white font-medium mb-2" id="loadingTitle">AI æ€è€ƒä¸­...</div>
      <div class="text-gray-400 text-sm mb-4" id="loadingSubtext">æ­£åœ¨ç”Ÿæˆæ•…äº‹å…§å®¹</div>
      <div class="loading-dots justify-center">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <!-- ä¸»è¦éŠæˆ²å€åŸŸ -->
  <main class="flex h-[calc(100vh-80px)] p-6 gap-6">
    <!-- å·¦å´è§’è‰²è³‡è¨Šé¢æ¿ -->
    <aside class="w-80 bg-gray-900/60 backdrop-blur-sm rounded-xl border border-gray-700/50 p-6 card-glow">
      <h2 class="text-xl font-bold text-amber-400 mb-6 flex items-center">
        <div class="w-6 h-6 flex items-center justify-center mr-2">
          <i class="ri-user-3-line"></i>
        </div>
        è§’è‰²è³‡è¨Š
      </h2>

      <!-- è§’è‰²é ­åƒ -->
      <div class="flex flex-col items-center mb-6">
        <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-amber-500 mb-3">
          <img
            src="https://readdy.ai/api/search-image?query=fantasy%20warrior%20character%20portrait%20with%20medieval%20armor%20and%20determined%20expression%2C%20detailed%20digital%20art%20style%2C%20warm%20lighting%2C%20heroic%20pose%2C%20fantasy%20game%20character%20design&width=200&height=200&seq=character001&orientation=squarish"
            alt="è§’è‰²é ­åƒ" class="w-full h-full object-cover object-top" />
        </div>
        <h3 class="text-lg font-bold text-white">è‰¾ç‘å…‹Â·éµå¿ƒ</h3>
        <p class="text-sm text-gray-400">äººé¡æˆ°å£« Â· ç­‰ç´š 3</p>
      </div>

      <!-- åŸºæœ¬å±¬æ€§ -->
      <div class="space-y-4 mb-6">
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-lg font-bold text-red-400">16</div>
            <div class="text-xs text-gray-400">åŠ›é‡</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-lg font-bold text-green-400">14</div>
            <div class="text-xs text-gray-400">æ•æ·</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-lg font-bold text-blue-400">13</div>
            <div class="text-xs text-gray-400">æ™ºåŠ›</div>
          </div>
        </div>
      </div>

      <!-- ç”Ÿå‘½å€¼/é­”åŠ›å€¼ -->
      <div class="space-y-3 mb-6">
        <div>
          <div class="flex justify-between text-sm mb-1">
            <span class="text-red-400">ç”Ÿå‘½å€¼</span>
            <span>42/50</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-3">
            <div class="progress-bar h-3 rounded-full" style="width: 84%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-sm mb-1">
            <span class="text-blue-400">é­”åŠ›å€¼</span>
            <span>18/25</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-3">
            <div class="bg-blue-500 h-3 rounded-full" style="width: 72%"></div>
          </div>
        </div>
      </div>

      <!-- è£å‚™/é“å…· -->
      <div>
        <h4 class="text-sm font-bold text-amber-400 mb-3">è£å‚™é“å…·</h4>
        <div class="grid grid-cols-2 gap-2">
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="ri-sword-line text-amber-400 text-lg"></i>
            </div>
            <div class="text-xs text-gray-300">é‹¼éµé•·åŠ</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="ri-shield-line text-gray-400 text-lg"></i>
            </div>
            <div class="text-xs text-gray-300">çš®é©ç›¾ç‰Œ</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="ri-flask-line text-red-400 text-lg"></i>
            </div>
            <div class="text-xs text-gray-300">æ²»ç™‚è—¥æ°´ x3</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="ri-coins-line text-yellow-400 text-lg"></i>
            </div>
            <div class="text-xs text-gray-300">é‡‘å¹£ x127</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ä¸­å¤®éŠæˆ²äº’å‹•å€ -->
    <section
      class="flex-1 bg-gray-900/60 backdrop-blur-sm rounded-xl border border-gray-700/50 p-6 card-glow flex flex-col overflow-hidden">
      <!-- æ•…äº‹åŠ‡æƒ…é¡¯ç¤ºæ¡† -->
      <div class="flex-1 mb-6 overflow-hidden">
        <div class="h-full bg-gray-800/30 rounded-lg p-6 overflow-y-auto overscroll-y-contain">
          <div id="storyContent" class="space-y-4">
            <div class="text-fade-in">
              <p class="text-gray-300 leading-relaxed mb-4">
                ä½ ç«™åœ¨ä¸€åº§å¤è€åŸå ¡çš„å¤§é–€å‰ï¼Œåšé‡çš„çŸ³é–€ä¸Šåˆ»æ»¿äº†ç¥ç§˜çš„ç¬¦æ–‡ã€‚å¾®é¢¨å¹éï¼Œå¸¶ä¾†äº†ä¸€çµ²ä¸ç¥¥çš„æ°£æ¯ã€‚é è™•å‚³ä¾†ä½æ²‰çš„å’†å“®è²ï¼Œä¼¼ä¹æœ‰ä»€éº¼å±éšªçš„ç”Ÿç‰©æ­£åœ¨åŸå ¡æ·±è™•ç­‰å¾…è‘—ã€‚
              </p>
              <p class="text-amber-300 font-medium">
                ä½ æ³¨æ„åˆ°é–€ä¸Šæœ‰ä¸‰å€‹ä¸åŒçš„ç¬¦æ–‡æŒ‰éˆ•ï¼Œæ¯å€‹éƒ½æ•£ç™¼è‘—ä¸åŒé¡è‰²çš„å…‰èŠ’...
              </p>
            </div>

            <div class="border-l-4 border-purple-500 pl-4 bg-purple-900/20 rounded-r-lg p-3 text-fade-in">
              <p class="text-purple-300 italic">
                "å‹‡æ•¢çš„å†’éšªè€…å•Šï¼Œ"
                ä¸€å€‹ç¥ç§˜çš„è²éŸ³åœ¨ä½ è…¦æµ·ä¸­éŸ¿èµ·ï¼Œ"é¸æ“‡ä½ çš„é“è·¯å§ã€‚ç´…è‰²ç¬¦æ–‡é€šå¾€åŠ›é‡ä¹‹è·¯ï¼Œè—è‰²ç¬¦æ–‡å¼•å‘æ™ºæ…§ä¹‹é–€ï¼Œè€Œé‡‘è‰²ç¬¦æ–‡å‰‡æ˜¯å‹‡æ°£çš„è±¡å¾µã€‚æ¯ä¸€å€‹é¸æ“‡éƒ½å°‡æ±ºå®šä½ çš„å‘½é‹..."
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- é¸é …æŒ‰éˆ•çµ„ -->
      <div class="space-y-3">
        <button
          class="w-full bg-red-600/20 hover:bg-red-600/40 border border-red-500/50 rounded-lg p-4 text-left transition-all duration-200 group !rounded-button whitespace-nowrap">
          <div class="flex items-center">
            <div
              class="w-8 h-8 flex items-center justify-center shrink-0 mr-3 bg-red-500 rounded-full group-hover:scale-110 transition-transform">
              <i class="ri-fire-line text-white"></i>
            </div>
            <div>
              <div class="font-medium text-red-300">æŒ‰ä¸‹ç´…è‰²ç¬¦æ–‡</div>
              <div class="text-sm text-gray-400">æ†‘è—‰åŠ›é‡å¼·è¡Œæ¨é–‹å¤§é–€</div>
            </div>
          </div>
        </button>

        <button
          class="w-full bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/50 rounded-lg p-4 text-left transition-all duration-200 group !rounded-button whitespace-nowrap">
          <div class="flex items-center">
            <div
              class="w-8 h-8 flex items-center justify-center shrink-0 mr-3 bg-blue-500 rounded-full group-hover:scale-110 transition-transform">
              <i class="ri-brain-line text-white"></i>
            </div>
            <div>
              <div class="font-medium text-blue-300">æŒ‰ä¸‹è—è‰²ç¬¦æ–‡</div>
              <div class="text-sm text-gray-400">é‹ç”¨æ™ºæ…§è§£è®€ç¬¦æ–‡çš„å¥§ç§˜</div>
            </div>
          </div>
        </button>

        <button
          class="w-full bg-amber-600/20 hover:bg-amber-600/40 border border-amber-500/50 rounded-lg p-4 text-left transition-all duration-200 group !rounded-button whitespace-nowrap">
          <div class="flex items-center">
            <div
              class="w-8 h-8 flex items-center justify-center shrink-0 mr-3 bg-amber-500 rounded-full group-hover:scale-110 transition-transform">
              <i class="ri-heart-line text-white"></i>
            </div>
            <div>
              <div class="font-medium text-amber-300">æŒ‰ä¸‹é‡‘è‰²ç¬¦æ–‡</div>
              <div class="text-sm text-gray-400">ä»¥å‹‡æ°£é¢å°æœªçŸ¥çš„æŒ‘æˆ°</div>
            </div>
          </div>
        </button>
      </div>
    </section>

    <!-- å³å´éŠæˆ²æ§åˆ¶é¢æ¿ -->
    <aside
      class="w-80 bg-gray-900/60 backdrop-blur-sm rounded-xl border border-gray-700/50 p-6 card-glow overflow-y-auto overscroll-y-contain">
      <h2 class="text-xl font-bold text-amber-400 mb-6 flex items-center">
        <div class="w-6 h-6 flex items-center justify-center mr-2">
          <i class="ri-gamepad-line"></i>
        </div>
        éŠæˆ²æ§åˆ¶
      </h2>

      <!-- æ“²éª°å€åŸŸ -->
      <div class="mb-8">
        <h3 class="text-lg font-medium text-white mb-4">æ“²éª°å­</h3>
        <div class="bg-gray-800/50 rounded-lg p-4 text-center mb-4">
          <div id="diceResult" class="text-4xl font-bold text-amber-400 mb-2">
            ?
          </div>
          <div class="text-sm text-gray-400">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ“²éª°</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button id="rollD20"
            class="bg-primary hover:bg-blue-600 rounded-lg p-3 text-center transition-colors !rounded-button whitespace-nowrap">
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="ri-dice-line text-white text-lg"></i>
            </div>
            <div class="text-sm font-medium">D20</div>
          </button>
          <button id="rollD12"
            class="bg-secondary hover:bg-purple-600 rounded-lg p-3 text-center transition-colors !rounded-button whitespace-nowrap">
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="ri-dice-line text-white text-lg"></i>
            </div>
            <div class="text-sm font-medium">D12</div>
          </button>
          <button id="rollD10"
            class="bg-green-600 hover:bg-green-700 rounded-lg p-3 text-center transition-colors !rounded-button whitespace-nowrap">
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="ri-dice-line text-white text-lg"></i>
            </div>
            <div class="text-sm font-medium">D10</div>
          </button>
          <button id="rollD6"
            class="bg-orange-600 hover:bg-orange-700 rounded-lg p-3 text-center transition-colors !rounded-button whitespace-nowrap">
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="ri-dice-line text-white text-lg"></i>
            </div>
            <div class="text-sm font-medium">D6</div>
          </button>
        </div>
      </div>

      <!-- è¡Œå‹•é¸é … -->
      <div class="mb-8">
        <h3 class="text-lg font-medium text-white mb-4">å¿«é€Ÿè¡Œå‹•</h3>
        <div class="space-y-2">
          <button
            class="w-full bg-gray-700 hover:bg-gray-600 rounded-lg p-3 text-left transition-colors !rounded-button whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-6 h-6 flex items-center justify-center mr-3">
                <i class="ri-search-line text-gray-300"></i>
              </div>
              <span class="text-sm">èª¿æŸ¥ç’°å¢ƒ</span>
            </div>
          </button>
          <button
            class="w-full bg-gray-700 hover:bg-gray-600 rounded-lg p-3 text-left transition-colors !rounded-button whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-6 h-6 flex items-center justify-center mr-3">
                <i class="ri-run-line text-gray-300"></i>
              </div>
              <span class="text-sm">ç§»å‹•ä½ç½®</span>
            </div>
          </button>
          <button
            class="w-full bg-gray-700 hover:bg-gray-600 rounded-lg p-3 text-left transition-colors !rounded-button whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-6 h-6 flex items-center justify-center mr-3">
                <i class="ri-hand-heart-line text-gray-300"></i>
              </div>
              <span class="text-sm">ä½¿ç”¨é“å…·</span>
            </div>
          </button>
        </div>
      </div>

      <!-- æŠ€èƒ½å¿«æ·éµ -->
      <div>
        <h3 class="text-lg font-medium text-white mb-4">æŠ€èƒ½å¿«æ·éµ</h3>
        <div class="grid grid-cols-2 gap-3">
          <button
            class="bg-red-600/20 border border-red-500/50 rounded-lg p-3 text-center hover:bg-red-600/40 transition-colors !rounded-button whitespace-nowrap">
            <div class="w-6 h-6 flex items-center justify-center mx-auto mb-1">
              <i class="ri-sword-line text-red-400"></i>
            </div>
            <div class="text-xs text-red-300">æ”»æ“Š</div>
          </button>
          <button
            class="bg-blue-600/20 border border-blue-500/50 rounded-lg p-3 text-center hover:bg-blue-600/40 transition-colors !rounded-button whitespace-nowrap">
            <div class="w-6 h-6 flex items-center justify-center mx-auto mb-1">
              <i class="ri-shield-line text-blue-400"></i>
            </div>
            <div class="text-xs text-blue-300">é˜²ç¦¦</div>
          </button>
          <button
            class="bg-green-600/20 border border-green-500/50 rounded-lg p-3 text-center hover:bg-green-600/40 transition-colors !rounded-button whitespace-nowrap">
            <div class="w-6 h-6 flex items-center justify-center mx-auto mb-1">
              <i class="ri-heart-pulse-line text-green-400"></i>
            </div>
            <div class="text-xs text-green-300">æ²»ç™‚</div>
          </button>
          <button
            class="bg-purple-600/20 border border-purple-500/50 rounded-lg p-3 text-center hover:bg-purple-600/40 transition-colors !rounded-button whitespace-nowrap">
            <div class="w-6 h-6 flex items-center justify-center mx-auto mb-1">
              <i class="ri-magic-line text-purple-400"></i>
            </div>
            <div class="text-xs text-purple-300">æ³•è¡“</div>
          </button>
        </div>
      </div>
    </aside>
  </main>

  <script src="footer.js"></script>

  <script id="diceRollSystem">
    class DiceSystem {
      constructor() {
        this.diceTypes = {
          d20: 20,
          d12: 12,
          d10: 10,
          d6: 6
        };

        this.diceResult = document.getElementById("diceResult");
        this.setupEventListeners();
      }

      setupEventListeners() {
        Object.entries(this.diceTypes).forEach(([type, max]) => {
          const button = document.getElementById(`roll${type.toUpperCase()}`);
          if (button) {
            button.addEventListener("click", () => this.rollDice(max));
          }
        });
      }

      async rollDice(max, isAuto = false) {
        const result = Math.floor(Math.random() * max) + 1;

        // é¡¯ç¤ºå‹•ç•«
        this.diceResult.classList.add("dice-animation");
        this.diceResult.textContent = "ğŸ²";

        // ç­‰å¾…å‹•ç•«å®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 600));

        this.diceResult.textContent = result;
        this.diceResult.classList.remove("dice-animation");

        // è™•ç†ç‰¹æ®Šçµæœ
        if (result === max) {
          this.diceResult.classList.add("text-amber-400");
          setTimeout(() => this.diceResult.classList.remove("text-amber-400"), 2000);
        } else if (result === 1) {
          this.diceResult.classList.add("text-red-400");
          setTimeout(() => this.diceResult.classList.remove("text-red-400"), 2000);
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦é€šçŸ¥æ•…äº‹ç³»çµ±
        if (storyManager && storyManager.waitingForDice) {
          const diceTypeMap = { 20: 'd20', 12: 'd12', 10: 'd10', 6: 'd6' };
          const diceType = diceTypeMap[max];
          if (diceType && storyManager.waitingForDice === diceType) {
            // ç¢ºä¿è§’è‰²ç®¡ç†å™¨å·²åˆå§‹åŒ–ä¸¦é€£æ¥åˆ°æ•…äº‹ç®¡ç†å™¨
            if (characterManager) {
              console.log('æ“²éª°ç³»çµ±ï¼šé€šçŸ¥æ•…äº‹ç®¡ç†å™¨è™•ç†çµæœï¼Œè§’è‰²ç®¡ç†å™¨å·²å°±ç·’');
            } else {
              console.warn('æ“²éª°ç³»çµ±ï¼šè§’è‰²ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–');
            }
            storyManager.handleDiceRoll(diceType, result);
          }
        }

        // å¦‚æœæ˜¯è‡ªå‹•æ“²éª°ï¼Œè§¸ç™¼å›èª¿
        if (isAuto && this.onAutoRollComplete) {
          this.onAutoRollComplete(max, result);
        }

        return result;
      }

      // è‡ªå‹•æ“²éª°ä¸¦è¿”å›çµæœ
      async autoRoll(diceType) {
        console.log('autoRoll è¢«èª¿ç”¨ï¼Œéª°å­é¡å‹:', diceType);
        const max = this.diceTypes[diceType.toLowerCase()];
        if (!max) {
          console.error('ç„¡æ•ˆçš„éª°å­é¡å‹:', diceType);
          return null;
        }
        console.log('é–‹å§‹æ“²éª°ï¼Œæœ€å¤§å€¼:', max);
        const result = await this.rollDice(max, true);
        console.log('æ“²éª°å®Œæˆï¼Œçµæœ:', result);
        return result;
      }

      // è¨­ç½®è‡ªå‹•æ“²éª°å®Œæˆçš„å›èª¿
      setAutoRollCallback(callback) {
        this.onAutoRollComplete = callback;
      }
    }

    // åˆå§‹åŒ–éª°å­ç³»çµ±
    let diceSystem;
    document.addEventListener("DOMContentLoaded", function () {
      diceSystem = new DiceSystem();
    });
  </script>

  <script id="storySystem">
    class StoryManager {
      constructor() {
        this.storyContent = document.getElementById('storyContent');
        this.choiceButtons = document.querySelectorAll('.w-full[class*="bg-"][class*="-600/20"]');
        this.waitingForDice = null; // ç­‰å¾…æ“²éª°çš„ç‹€æ…‹
        this.waitingForDiceContext = null; // æ“²éª°çš„ä¸Šä¸‹æ–‡
        this.setupEventListeners();
      }

      setupEventListeners() {
        this.choiceButtons.forEach(button => {
          button.addEventListener('click', async () => {
            const choice = button.querySelector('.font-medium').textContent;
            const description = button.querySelector('.text-sm').textContent;

            // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
            this.disableChoiceButtons();

            // é¡¯ç¤º loading
            gameAI.showLoading('æ­£åœ¨ç”Ÿæˆæ•…äº‹å…§å®¹...', 'è«‹ç¨å€™ï¼Œ AI æ­£åœ¨æ€è€ƒä¸­');

            let message;
            if (choice === 'æŒ‰ä¸‹ç´…è‰²ç¬¦æ–‡' || choice === 'æŒ‰ä¸‹è—è‰²ç¬¦æ–‡' || choice === 'æŒ‰ä¸‹é‡‘è‰²ç¬¦æ–‡') {
              // å¦‚æœæ˜¯åˆå§‹ç¬¦æ–‡é¸æ“‡ï¼Œé–‹å§‹æ–°çš„æ•…äº‹
              message = `è«‹ç”Ÿæˆä¸€å€‹å…¨æ–°çš„é¾èˆ‡åœ°ä¸‹åŸå†’éšªæ•…äº‹é–‹å ´ã€‚

âš ï¸ æ¥µé‡è¦æé†’ï¼šæ‰€æœ‰è¼¸å‡ºå¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œçµ•å°ä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼

æ ¼å¼è¦æ±‚ï¼š
1. æ‰€æœ‰æ–‡å­—å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡
2. é‡è¦çš„é¸é …æˆ–é—œéµå­—ä½¿ç”¨ **ç²—é«”** æ¨™è¨˜
3. ä½¿ç”¨ç©ºè¡Œä¾†åˆ†éš”æ®µè½
4. å¿…é ˆæä¾›æ°å¥½ä¸‰å€‹é¸é …ï¼ˆä¸èƒ½å¤šä¹Ÿä¸èƒ½å°‘ï¼‰
5. é¸é …å¿…é ˆä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼ˆåŒ…å«åˆ†éš”ç·šï¼‰ï¼š

===é¸é …é–‹å§‹===
1. **ç¬¬ä¸€å€‹é¸é …** - ç¬¬ä¸€å€‹é¸é …çš„è©³ç´°æè¿°
2. **ç¬¬äºŒå€‹é¸é …** - ç¬¬äºŒå€‹é¸é …çš„è©³ç´°æè¿°
3. **ç¬¬ä¸‰å€‹é¸é …** - ç¬¬ä¸‰å€‹é¸é …çš„è©³ç´°æè¿°
===é¸é …çµæŸ===

è«‹ç¢ºä¿æä¾›ä¸‰å€‹é¸é …ï¼Œæ¯å€‹é¸é …éƒ½è¦æœ‰æ˜ç¢ºçš„æ¨™é¡Œå’Œè©³ç´°çš„æè¿°ã€‚
çµ•å°ä¸è¦ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼Œæ‰€æœ‰æ–‡å­—éƒ½å¿…é ˆæ˜¯ç¹é«”ä¸­æ–‡ï¼
              
              ç©å®¶é¸æ“‡äº†ï¼š${choice}
              æè¿°ï¼š${description}`;
            } else {
              // ä¸€èˆ¬çš„é¸é …é¸æ“‡
              message = `è«‹ç”Ÿæˆæ•…äº‹çš„å¾ŒçºŒç™¼å±•ã€‚

âš ï¸ æ¥µé‡è¦æé†’ï¼šæ‰€æœ‰è¼¸å‡ºå¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œçµ•å°ä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼

æ ¼å¼è¦æ±‚ï¼š
1. æ‰€æœ‰æ–‡å­—å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡
2. é‡è¦çš„é¸é …æˆ–é—œéµå­—ä½¿ç”¨ **ç²—é«”** æ¨™è¨˜
3. ä½¿ç”¨ç©ºè¡Œä¾†åˆ†éš”æ®µè½
4. å¿…é ˆæä¾›æ°å¥½ä¸‰å€‹é¸é …ï¼ˆä¸èƒ½å¤šä¹Ÿä¸èƒ½å°‘ï¼‰
5. é¸é …å¿…é ˆä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼ˆåŒ…å«åˆ†éš”ç·šï¼‰ï¼š

===é¸é …é–‹å§‹===
1. **ç¬¬ä¸€å€‹é¸é …** - ç¬¬ä¸€å€‹é¸é …çš„è©³ç´°æè¿°
2. **ç¬¬äºŒå€‹é¸é …** - ç¬¬äºŒå€‹é¸é …çš„è©³ç´°æè¿°
3. **ç¬¬ä¸‰å€‹é¸é …** - ç¬¬ä¸‰å€‹é¸é …çš„è©³ç´°æè¿°
===é¸é …çµæŸ===

è«‹ç¢ºä¿æä¾›ä¸‰å€‹é¸é …ï¼Œæ¯å€‹é¸é …éƒ½è¦æœ‰æ˜ç¢ºçš„æ¨™é¡Œå’Œè©³ç´°çš„æè¿°ã€‚
çµ•å°ä¸è¦ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼Œæ‰€æœ‰æ–‡å­—éƒ½å¿…é ˆæ˜¯ç¹é«”ä¸­æ–‡ï¼
              
              ç©å®¶é¸æ“‡äº†ï¼š${choice}
              æè¿°ï¼š${description}`;
            }

            // æ·»åŠ ç©å®¶é¸æ“‡åˆ°æ•…äº‹ï¼ˆä¸è‡ªå‹•æ»¾å‹•ï¼‰
            this.appendToStory('player-choice', `ä½ é¸æ“‡äº†ï¼š${choice} - ${description}`, false);

            try {
              // ç™¼é€é¸æ“‡çµ¦ AI
              const aiResponse = await gameAI.sendMessage(message);

              // è§£æ AI å›æ‡‰
              this.handleAIResponse(aiResponse);
            } catch (error) {
              // éš±è— loading
              gameAI.hideLoading();
              // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
              this.enableChoiceButtons();
              console.error('AI å›æ‡‰éŒ¯èª¤:', error);
            }
          });
        });
      }

      appendToStory(type, content, shouldScroll = true) {
        const div = document.createElement('div');
        div.className = 'text-fade-in my-4';

        if (type === 'player-choice') {
          div.innerHTML = `
            <div class="border-l-4 border-blue-500 pl-4 bg-blue-900/20 rounded-r-lg p-3">
              <p class="text-blue-300">${content}</p>
            </div>
          `;
        } else if (type === 'ai-response') {
          div.innerHTML = `
            <div class="text-gray-300 leading-relaxed mb-4">
              <p>${content}</p>
            </div>
          `;
        } else if (type === 'system-message') {
          div.innerHTML = `
            <div class="border-l-4 border-purple-500 pl-4 bg-purple-900/20 rounded-r-lg p-3">
              <p class="text-purple-300 italic">${content}</p>
            </div>
          `;
        }

        this.storyContent.appendChild(div);
        if (shouldScroll) {
          // åªåœ¨æ•…äº‹å€åŸŸå…§æ»¾å‹•ï¼Œä¸å½±éŸ¿æ•´å€‹é é¢
          this.storyContent.scrollTop = this.storyContent.scrollHeight;
        }
      }

      async handleAIResponse(response) {
        // æª¢æŸ¥æ˜¯å¦éœ€è¦æ“²éª° - æ”¯æ´å¤šç¨®æ ¼å¼
        let diceMatch = response.match(/éœ€è¦æ“²\s*\*\*?(\w+)\*\*?\s*éª°å­/);
        if (!diceMatch) {
          // å˜—è©¦å…¶ä»–å¯èƒ½çš„æ ¼å¼
          diceMatch = response.match(/éœ€è¦é€²è¡Œ.*?(\w+)æª¢å®š/);
        }
        if (!diceMatch) {
          // å˜—è©¦æ›´å¯¬é¬†çš„æ ¼å¼
          diceMatch = response.match(/éœ€è¦.*?(\w+).*?éª°å­/);
        }
        if (!diceMatch) {
          // å˜—è©¦æª¢å®šæ ¼å¼
          diceMatch = response.match(/éœ€è¦.*?(\w+)æª¢å®š/);
        }

        if (diceMatch) {
          const diceType = diceMatch[1].toLowerCase();
          console.log('æª¢æ¸¬åˆ°æ“²éª°è¦æ±‚:', diceMatch[0], 'éª°å­é¡å‹:', diceType);

          // å…ˆé¡¯ç¤º AI çš„åŸå§‹å›æ‡‰ï¼ˆåŒ…å«æ“²éª°è¦æ±‚ï¼‰
          const formattedOriginalResponse = response
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n\n/g, '</p><p class="mb-4">')
            .replace(/\n/g, '<br>');
          const wrappedOriginalResponse = `<p class="mb-4">${formattedOriginalResponse}</p>`;
          this.appendToStory('ai-response', wrappedOriginalResponse);

          // é¡¯ç¤ºæ“²éª°æç¤ºï¼Œä½†ä¸è‡ªå‹•åŸ·è¡Œ
          this.appendToStory('system-message', `è«‹é»æ“Šå³å´é¢æ¿çš„ <strong>${diceType.toUpperCase()}</strong> éª°å­æŒ‰éˆ•ä¾†é€²è¡Œæª¢å®šï¼`);

          // è¨­ç½®ç­‰å¾…æ“²éª°ç‹€æ…‹
          this.waitingForDice = diceType;
          this.waitingForDiceContext = response;

          // ç¦ç”¨é¸é …æŒ‰éˆ•ï¼Œé˜²æ­¢ç©å®¶åœ¨æ“²éª°å‰é¸æ“‡å…¶ä»–é¸é …
          this.disableChoiceButtons();

          // é«˜äº®å°æ‡‰çš„éª°å­æŒ‰éˆ•
          this.highlightDiceButton(diceType);

          return; // ç­‰å¾…ç©å®¶æ‰‹å‹•æ“²éª°
        }

        // è§£æé¸é …
        console.log('åŸå§‹å›æ‡‰:', response);

        // å°‹æ‰¾é¸é …é–‹å§‹å’ŒçµæŸçš„æ¨™è¨˜
        const optionsStartIndex = response.indexOf('===é¸é …é–‹å§‹===');
        const optionsEndIndex = response.indexOf('===é¸é …çµæŸ===');

        let options = [];

        if (optionsStartIndex !== -1 && optionsEndIndex !== -1) {
          // æå–é¸é …éƒ¨åˆ†
          const optionsSection = response.substring(optionsStartIndex, optionsEndIndex);
          console.log('é¸é …éƒ¨åˆ†:', optionsSection);

          // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼åŒ¹é…é¸é …
          const optionPattern = /(\d+)\.\s*\*\*(.*?)\*\*\s*[-â€“]\s*(.*?)(?=\n\d+\.|\n*$)/gs;
          let match;

          while ((match = optionPattern.exec(optionsSection)) !== null) {
            console.log('æ‰¾åˆ°é¸é …:', match);
            const [, number, title, description] = match;
            options.push({
              title: title.trim(),
              description: description.trim()
            });
          }

          // ç§»é™¤åŸæ–‡ä¸­çš„é¸é …éƒ¨åˆ†
          response = response.substring(0, optionsStartIndex);
        } else {
          // å¦‚æœæ²’æœ‰æ‰¾åˆ°é¸é …æ¨™è¨˜ï¼Œå˜—è©¦ä½¿ç”¨èˆŠçš„æ­£å‰‡è¡¨é”å¼
          const optionsPattern = /(\d)\.\s*\*\*(.*?)\*\*\s*[-â€“]\s*(.*?)(?=\n\d\.|\n*$|\n\n|$)/gs;
          let match;

          while ((match = optionsPattern.exec(response)) !== null) {
            console.log('æ‰¾åˆ°é¸é …:', match);
            const [, number, title, description] = match;
            options.push({
              title: title.trim(),
              description: description.trim()
            });
          }

          // ç§»é™¤åŸæ–‡ä¸­çš„é¸é …éƒ¨åˆ†ï¼ˆå¾ç¬¬ä¸€å€‹é¸é …é–‹å§‹çš„ä½ç½®ï¼‰
          const firstOptionIndex = response.indexOf('1.');
          if (firstOptionIndex !== -1) {
            response = response.substring(0, firstOptionIndex);
          }
        }

        console.log('è§£æå¾Œçš„é¸é …:', options);

        if (options.length === 3) {
          // æ›´æ–°é¸é …æŒ‰éˆ•
          this.updateChoices(options);
        } else {
          console.warn('æœªæ‰¾åˆ°æ­£ç¢ºçš„ä¸‰å€‹é¸é …ï¼Œå¯¦éš›æ‰¾åˆ°:', options.length);
          // å¦‚æœæ²’æœ‰æ­£ç¢ºçš„ä¸‰å€‹é¸é …ï¼Œä½¿ç”¨é è¨­é¸é …
          options = [
            { title: 'æ¢ç´¢å‰æ–¹', description: 'è¬¹æ…åœ°å‘å‰æ¢ç´¢æœªçŸ¥çš„å€åŸŸ' },
            { title: 'æœç´¢å‘¨åœ', description: 'ä»”ç´°æœç´¢ç•¶å‰å€åŸŸå°‹æ‰¾ç·šç´¢' },
            { title: 'èˆ‡NPCå°è©±', description: 'å˜—è©¦èˆ‡å‘¨åœçš„è§’è‰²é€²è¡Œäº¤è«‡' }
          ];
          this.updateChoices(options);
        }

        // è™•ç†å‰©é¤˜æ–‡æœ¬çš„ markdown èªæ³•
        const formattedResponse = response
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // è™•ç†ç²—é«”
          .replace(/\n\n/g, '</p><p class="mb-4">') // è™•ç†æ®µè½
          .replace(/\n/g, '<br>'); // è™•ç†æ›è¡Œ

        // ç¢ºä¿å›æ‡‰æœ‰é©ç•¶çš„æ®µè½åŒ…è£¹
        const wrappedResponse = `<p class="mb-4">${formattedResponse}</p>`;

        // æ›´æ–°é¸é …æŒ‰éˆ•
        if (options.length > 0) {
          this.updateChoices(options);
        }

        this.appendToStory('ai-response', wrappedResponse);

        // é‡æ–°å•Ÿç”¨é¸é …æŒ‰éˆ•ï¼ˆå¦‚æœä¹‹å‰å› ç‚ºç­‰å¾…æ“²éª°è€Œè¢«ç¦ç”¨ï¼‰
        this.enableChoiceButtons();
      }

      updateChoices(choices) {
        // ç¢ºä¿æˆ‘å€‘æœ‰ä¸‰å€‹æŒ‰éˆ•å¯ä»¥æ›´æ–°
        const buttons = Array.from(this.choiceButtons).slice(0, 3);

        // æ›´æ–°æ¯å€‹æŒ‰éˆ•
        buttons.forEach((button, index) => {
          if (choices[index]) {
            const { title, description } = choices[index];
            button.querySelector('.font-medium').textContent = title;
            button.querySelector('.text-sm').textContent = description;
            button.style.display = 'block';
          } else {
            // å¦‚æœæ²’æœ‰å°æ‡‰çš„é¸é …ï¼Œä½¿ç”¨é è¨­å€¼
            const defaults = [
              { title: 'æŒ‰ä¸‹ç´…è‰²ç¬¦æ–‡', description: 'æ†‘è—‰åŠ›é‡å¼·è¡Œæ¨é–‹å¤§é–€' },
              { title: 'æŒ‰ä¸‹è—è‰²ç¬¦æ–‡', description: 'é‹ç”¨æ™ºæ…§è§£è®€ç¬¦æ–‡çš„å¥§ç§˜' },
              { title: 'æŒ‰ä¸‹é‡‘è‰²ç¬¦æ–‡', description: 'ä»¥å‹‡æ°£é¢å°æœªçŸ¥çš„æŒ‘æˆ°' }
            ];
            const { title, description } = defaults[index];
            button.querySelector('.font-medium').textContent = title;
            button.querySelector('.text-sm').textContent = description;
            button.style.display = 'block';
          }
        });
      }

      highlightDiceButton(diceType) {
        // ç§»é™¤æ‰€æœ‰éª°å­æŒ‰éˆ•çš„é«˜äº®
        const allDiceButtons = document.querySelectorAll('#rollD20, #rollD12, #rollD10, #rollD6');
        allDiceButtons.forEach(btn => {
          btn.classList.remove('ring-4', 'ring-yellow-400', 'animate-pulse');
        });

        // é«˜äº®æŒ‡å®šçš„éª°å­æŒ‰éˆ•
        const targetButton = document.getElementById(`roll${diceType.toUpperCase()}`);
        if (targetButton) {
          targetButton.classList.add('ring-4', 'ring-yellow-400', 'animate-pulse');
        }
      }

      async handleDiceRoll(diceType, result) {
        // å¦‚æœæ­£åœ¨ç­‰å¾…é€™å€‹éª°å­çš„çµæœ
        if (this.waitingForDice === diceType.toLowerCase()) {
          // æ¸…é™¤ç­‰å¾…ç‹€æ…‹
          this.waitingForDice = null;

          // ç§»é™¤éª°å­æŒ‰éˆ•é«˜äº®
          this.highlightDiceButton('');

          // é¡¯ç¤ºæ“²éª°çµæœ
          this.appendToStory('system-message', `ä½ æ“²å‡ºäº† ${result} é»ï¼`);

          // æ ¹æ“šæ“²éª°çµæœè¨ˆç®—æˆåŠŸç¨‹åº¦
          const diceOutcome = this.calculateDiceOutcome(diceType, result);

          // é¡¯ç¤ºæ“²éª°æˆåŠŸç¨‹åº¦
          this.appendToStory('system-message', `æª¢å®šçµæœï¼š${diceOutcome.description}`);

          // é¡¯ç¤º loading
          gameAI.showLoading('æ­£åœ¨è™•ç†æ“²éª°çµæœ...', 'æ ¹æ“šä½ çš„æ“²éª°çµæœç”Ÿæˆå¾ŒçºŒåŠ‡æƒ…');

          try {
            // æ§‹å»ºåŒ…å«è§’è‰²æ•¸æ“šå’Œæ“²éª°çµæœçš„è©³ç´°æç¤º
            const characterData = characterManager ? characterManager.getCharacter() : null;
            const aiPrompt = this.buildDiceResultPrompt(diceType, result, diceOutcome, characterData);

            // å°‡æ“²éª°çµæœç™¼é€çµ¦ AI
            const aiResponse = await gameAI.sendMessage(aiPrompt);

            // è™•ç† AI çš„æ–°å›æ‡‰ï¼ŒåŒ…æ‹¬è§’è‰²æ•¸æ“šè®ŠåŒ–
            await this.handleAIResponseWithCharacter(aiResponse, diceOutcome);
          } catch (error) {
            gameAI.hideLoading();
            console.error('æ“²éª°çµæœè™•ç†éŒ¯èª¤:', error);
          }
        }
      }

      // è¨ˆç®—æ“²éª°çµæœçš„æˆåŠŸç¨‹åº¦
      calculateDiceOutcome(diceType, result) {
        const diceMax = { d20: 20, d12: 12, d10: 10, d6: 6 }[diceType.toLowerCase()];

        let outcome = {
          success: false,
          level: 'failure',
          description: '',
          modifier: 0
        };

        // æ ¹æ“šä¸åŒéª°å­é¡å‹åˆ¤å®šæˆåŠŸç¨‹åº¦
        switch (diceType.toLowerCase()) {
          case 'd20':
            if (result === 20) {
              outcome = { success: true, level: 'critical_success', description: 'å¤§æˆåŠŸï¼', modifier: 2.0 };
            } else if (result >= 16) {
              outcome = { success: true, level: 'success', description: 'æˆåŠŸ', modifier: 1.5 };
            } else if (result >= 11) {
              outcome = { success: true, level: 'partial_success', description: 'éƒ¨åˆ†æˆåŠŸ', modifier: 1.0 };
            } else if (result >= 6) {
              outcome = { success: false, level: 'failure', description: 'å¤±æ•—', modifier: 0.5 };
            } else if (result === 1) {
              outcome = { success: false, level: 'critical_failure', description: 'å¤§å¤±æ•—ï¼', modifier: 0 };
            } else {
              outcome = { success: false, level: 'failure', description: 'å¤±æ•—', modifier: 0.5 };
            }
            break;

          case 'd12':
            if (result >= 10) {
              outcome = { success: true, level: 'success', description: 'æˆåŠŸ', modifier: 1.5 };
            } else if (result >= 7) {
              outcome = { success: true, level: 'partial_success', description: 'éƒ¨åˆ†æˆåŠŸ', modifier: 1.0 };
            } else if (result >= 4) {
              outcome = { success: false, level: 'failure', description: 'å¤±æ•—', modifier: 0.5 };
            } else {
              outcome = { success: false, level: 'critical_failure', description: 'å¤§å¤±æ•—', modifier: 0 };
            }
            break;

          case 'd10':
            if (result >= 8) {
              outcome = { success: true, level: 'success', description: 'æˆåŠŸ', modifier: 1.5 };
            } else if (result >= 6) {
              outcome = { success: true, level: 'partial_success', description: 'éƒ¨åˆ†æˆåŠŸ', modifier: 1.0 };
            } else if (result >= 3) {
              outcome = { success: false, level: 'failure', description: 'å¤±æ•—', modifier: 0.5 };
            } else {
              outcome = { success: false, level: 'critical_failure', description: 'å¤§å¤±æ•—', modifier: 0 };
            }
            break;

          case 'd6':
            if (result >= 5) {
              outcome = { success: true, level: 'success', description: 'æˆåŠŸ', modifier: 1.2 };
            } else if (result >= 3) {
              outcome = { success: false, level: 'partial_failure', description: 'éƒ¨åˆ†å¤±æ•—', modifier: 0.8 };
            } else {
              outcome = { success: false, level: 'failure', description: 'å¤±æ•—', modifier: 0.3 };
            }
            break;
        }

        return outcome;
      }

      // æ§‹å»ºåŒ…å«è§’è‰²æ•¸æ“šçš„æ“²éª°çµæœæç¤º
      buildDiceResultPrompt(diceType, result, outcome, characterData) {
        const basePrompt = `
âš ï¸ æ¥µé‡è¦æé†’ï¼šæ‰€æœ‰è¼¸å‡ºå¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œçµ•å°ä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼

ç©å®¶æ“²${diceType.toUpperCase()}éª°å­çµæœï¼š
- é»æ•¸ï¼š${result}
- æª¢å®šçµæœï¼š${outcome.description}
- æˆåŠŸç¨‹åº¦ï¼š${outcome.level}
- æ•ˆæœå€ç‡ï¼š${outcome.modifier}

ç•¶å‰è§’è‰²ç‹€æ…‹ï¼š
- å§“åï¼š${characterData?.personal?.name || 'æœªçŸ¥'}
- ç­‰ç´šï¼š${characterData?.personal?.level || 1}
- ç”Ÿå‘½å€¼ï¼š${characterData?.resources?.hp?.current || 0}/${characterData?.resources?.hp?.max || 0}
- é­”åŠ›å€¼ï¼š${characterData?.resources?.mp?.current || 0}/${characterData?.resources?.mp?.max || 0}
- ç¶“é©—å€¼ï¼š${characterData?.resources?.experience?.current || 0}/${characterData?.resources?.experience?.max || 1000}

è«‹æ ¹æ“šæ“²éª°çµæœç”Ÿæˆæ•…äº‹å¾ŒçºŒç™¼å±•ï¼Œä¸¦åœ¨æ•…äº‹æœ€å¾Œæä¾›è§’è‰²æ•¸æ“šè®ŠåŒ–å»ºè­°ï¼š

æ ¼å¼è¦æ±‚ï¼š
1. æ‰€æœ‰æ–‡å­—å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡
2. æ•…äº‹å…§å®¹è¦åæ˜ æ“²éª°çµæœçš„æˆåŠŸ/å¤±æ•—ç¨‹åº¦
3. åœ¨æ•…äº‹æœ€å¾Œæ·»åŠ è§’è‰²æ•¸æ“šè®ŠåŒ–å»ºè­°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

===è§’è‰²è®ŠåŒ–å»ºè­°===
HP_CHANGE: +5 æˆ– -10 (æ ¹æ“šæƒ…æ³)
MP_CHANGE: -3 æˆ– +2 (æ ¹æ“šæƒ…æ³) 
EXP_CHANGE: +15 æˆ– +30 (æ ¹æ“šæˆåŠŸç¨‹åº¦)
GOLD_CHANGE: +5 æˆ– -2 (å¦‚é©ç”¨)
REASON: è®ŠåŒ–åŸå› çš„ç°¡çŸ­èªªæ˜
===è®ŠåŒ–å»ºè­°çµæŸ===

4. æä¾›ä¸‰å€‹æ–°çš„é¸é …ï¼š

===é¸é …é–‹å§‹===
1. **é¸é …æ¨™é¡Œ** - é¸é …æè¿°
2. **é¸é …æ¨™é¡Œ** - é¸é …æè¿°  
3. **é¸é …æ¨™é¡Œ** - é¸é …æè¿°
===é¸é …çµæŸ===

è«‹ç¢ºä¿æ ¹æ“šæ“²éª°çµæœçš„æˆåŠŸç¨‹åº¦çµ¦äºˆé©ç•¶çš„çå‹µæˆ–æ‡²ç½°ã€‚æˆåŠŸæ™‚ç²å¾—æ›´å¤šç¶“é©—å€¼å’Œçå‹µï¼Œå¤±æ•—æ™‚å¯èƒ½å—åˆ°å‚·å®³æˆ–æå¤±ã€‚
`;

        return basePrompt;
      }

      // è™•ç†åŒ…å«è§’è‰²è®ŠåŒ–çš„ AI å›æ‡‰
      async handleAIResponseWithCharacter(response, diceOutcome) {
        console.log('åŸå§‹ AI å›æ‡‰:', response);

        // è§£æè§’è‰²æ•¸æ“šè®ŠåŒ–
        const characterChanges = this.parseCharacterChanges(response);

        // å¥—ç”¨è§’è‰²æ•¸æ“šè®ŠåŒ–
        if (characterChanges && characterManager) {
          console.log('å¥—ç”¨è§’è‰²è®ŠåŒ–:', characterChanges);

          // å¥—ç”¨åŸºæœ¬æ•¸å€¼è®ŠåŒ–
          if (Object.keys(characterChanges.data.resources).length > 0 || Object.keys(characterChanges.data.inventory).length > 0) {
            characterManager.updateCharacter(characterChanges.data);
          }

          // è™•ç†çå‹µ
          if (characterChanges.rewards && characterChanges.rewards.length > 0) {
            for (const reward of characterChanges.rewards) {
              if (reward.type === 'item') {
                characterManager.addItem(reward.item);
                this.appendToStory('system-message', `ğŸ ç²å¾—ç‰©å“ï¼š${reward.item.name} x${reward.item.quantity}`);
              } else if (reward.type === 'equipment') {
                characterManager.addItem(reward.item);
                this.appendToStory('system-message', `âš”ï¸ ç²å¾—è£å‚™ï¼š${reward.item.name} - ${reward.item.description}`);

                // è©¢å•æ˜¯å¦ç«‹å³è£å‚™
                setTimeout(() => {
                  if (confirm(`ä½ ç²å¾—äº† ${reward.item.name}ï¼æ˜¯å¦ç«‹å³è£å‚™ï¼Ÿ\n\n${reward.item.description}`)) {
                    characterManager.equipItem(reward.item);
                    this.appendToStory('system-message', `âœ¨ å·²è£å‚™ï¼š${reward.item.name}`);
                  }
                }, 1000);
              }
            }
          }

          // é¡¯ç¤ºè®ŠåŒ–åŸå› 
          if (characterChanges.reason) {
            this.appendToStory('system-message', `${characterChanges.reason}`);
          }
        }

        // ç§»é™¤è§’è‰²è®ŠåŒ–å»ºè­°éƒ¨åˆ†ï¼Œåªè™•ç†æ•…äº‹å…§å®¹å’Œé¸é …
        const cleanResponse = this.cleanResponseFromCharacterData(response);

        // è™•ç†å‰©é¤˜çš„ AI å›æ‡‰ï¼ˆæ•…äº‹å…§å®¹å’Œé¸é …ï¼‰
        this.handleAIResponse(cleanResponse);
      }

      // è§£æè§’è‰²æ•¸æ“šè®ŠåŒ–å»ºè­°
      parseCharacterChanges(response) {
        const changeStartIndex = response.indexOf('===è§’è‰²è®ŠåŒ–å»ºè­°===');
        const changeEndIndex = response.indexOf('===è®ŠåŒ–å»ºè­°çµæŸ===');

        if (changeStartIndex === -1 || changeEndIndex === -1) {
          console.log('æœªæ‰¾åˆ°è§’è‰²è®ŠåŒ–å»ºè­°æ¨™è¨˜');
          return null;
        }

        const changeSection = response.substring(changeStartIndex, changeEndIndex);
        console.log('è§’è‰²è®ŠåŒ–å€æ®µ:', changeSection);

        const changes = {
          data: { resources: {}, inventory: {} },
          reason: '',
          rewards: []
        };

        // è§£æå„ç¨®è®ŠåŒ–
        const hpMatch = changeSection.match(/HP_CHANGE:\s*([+-]?\d+)/);
        const mpMatch = changeSection.match(/MP_CHANGE:\s*([+-]?\d+)/);
        const expMatch = changeSection.match(/EXP_CHANGE:\s*([+-]?\d+)/);
        const goldMatch = changeSection.match(/GOLD_CHANGE:\s*([+-]?\d+)/);
        const itemRewardMatch = changeSection.match(/ITEM_REWARD:\s*(.+?)(?=\n|$)/);
        const equipRewardMatch = changeSection.match(/EQUIP_REWARD:\s*(.+?)(?=\n|$)/);
        const reasonMatch = changeSection.match(/REASON:\s*(.+?)(?=\n|$)/);

        // å–å¾—ç•¶å‰è§’è‰²æ•¸æ“š
        const currentCharacter = characterManager ? characterManager.getCharacter() : null;
        if (!currentCharacter) return null;

        // å¥—ç”¨ HP è®ŠåŒ–
        if (hpMatch) {
          const hpChange = parseInt(hpMatch[1]);
          changes.data.resources.hp = {
            current: Math.max(0, Math.min(
              currentCharacter.resources.hp.max,
              currentCharacter.resources.hp.current + hpChange
            ))
          };
        }

        // å¥—ç”¨ MP è®ŠåŒ–
        if (mpMatch) {
          const mpChange = parseInt(mpMatch[1]);
          changes.data.resources.mp = {
            current: Math.max(0, Math.min(
              currentCharacter.resources.mp.max,
              currentCharacter.resources.mp.current + mpChange
            ))
          };
        }

        // å¥—ç”¨ç¶“é©—å€¼è®ŠåŒ–
        if (expMatch) {
          const expChange = parseInt(expMatch[1]);
          changes.data.resources.experience = {
            current: Math.min(
              currentCharacter.resources.experience.max,
              currentCharacter.resources.experience.current + expChange
            )
          };
        }

        // å¥—ç”¨é‡‘å¹£è®ŠåŒ–
        if (goldMatch) {
          const goldChange = parseInt(goldMatch[1]);
          changes.data.inventory = {
            ...currentCharacter.inventory,
            gold: Math.max(0, currentCharacter.inventory.gold + goldChange)
          };
        }

        // è™•ç†ç‰©å“çå‹µ
        if (itemRewardMatch) {
          const rewardData = itemRewardMatch[1].trim();
          const parts = rewardData.split('|');

          if (parts.length >= 5) {
            const [name, icon, type, quantity, description] = parts;
            const item = {
              name: name.trim(),
              icon: icon.trim(),
              type: type.trim(),
              quantity: parseInt(quantity.trim()) || 1,
              description: description.trim()
            };

            changes.rewards.push({
              type: 'item',
              item: item
            });
          }
        }

        // è™•ç†è£å‚™çå‹µ
        if (equipRewardMatch) {
          const rewardData = equipRewardMatch[1].trim();
          const parts = rewardData.split('|');

          if (parts.length >= 6) {
            const [name, icon, equipType, statsStr, specialEffect, description] = parts;

            // è§£æå±¬æ€§åŠ æˆ
            const stats = {};
            if (statsStr.trim()) {
              statsStr.split(',').forEach(statPair => {
                const [stat, value] = statPair.trim().split(':');
                if (stat && value) {
                  stats[stat.trim()] = parseInt(value.trim()) || 0;
                }
              });
            }

            const equipment = {
              name: name.trim(),
              icon: icon.trim(),
              type: equipType.trim(),
              stats: stats,
              description: description.trim()
            };

            // è™•ç†ç‰¹æ®Šæ•ˆæœ (hpBonus, mpBonus ç­‰)
            if (specialEffect.trim()) {
              const effects = specialEffect.trim().split(',');
              effects.forEach(effect => {
                const [effectType, value] = effect.trim().split(':');
                if (effectType && value) {
                  equipment[effectType.trim()] = parseInt(value.trim()) || 0;
                }
              });
            }

            changes.rewards.push({
              type: 'equipment',
              item: equipment
            });
          }
        }

        // è¨­å®šè®ŠåŒ–åŸå› 
        if (reasonMatch) {
          changes.reason = reasonMatch[1].trim();
        }

        return changes;
      }

      // æ¸…ç† AI å›æ‡‰ä¸­çš„è§’è‰²æ•¸æ“šéƒ¨åˆ†
      cleanResponseFromCharacterData(response) {
        const changeStartIndex = response.indexOf('===è§’è‰²è®ŠåŒ–å»ºè­°===');
        if (changeStartIndex !== -1) {
          return response.substring(0, changeStartIndex).trim();
        }
        return response;
      }

      disableChoiceButtons() {
        this.choiceButtons.forEach(button => {
          button.disabled = true;
          button.classList.add('opacity-50', 'cursor-not-allowed');
          button.classList.remove('hover:bg-red-600/40', 'hover:bg-blue-600/40', 'hover:bg-amber-600/40');
        });
      }

      enableChoiceButtons() {
        this.choiceButtons.forEach((button, index) => {
          button.disabled = false;
          button.classList.remove('opacity-50', 'cursor-not-allowed');

          // é‡æ–°æ·»åŠ é©ç•¶çš„ hover æ•ˆæœ
          if (index === 0) {
            button.classList.add('hover:bg-red-600/40');
          } else if (index === 1) {
            button.classList.add('hover:bg-blue-600/40');
          } else if (index === 2) {
            button.classList.add('hover:bg-amber-600/40');
          }
        });
      }
    }

    // åˆå§‹åŒ–æ•…äº‹ç³»çµ±
    let storyManager;
    document.addEventListener('DOMContentLoaded', () => {
      storyManager = new StoryManager();

      // ç¢ºä¿éª°å­ç³»çµ±å’Œæ•…äº‹ç³»çµ±èƒ½æ­£ç¢ºå”ä½œ
      if (diceSystem) {
        diceSystem.setAutoRollCallback((diceType, result) => {
          console.log(`è‡ªå‹•æ“²éª°å®Œæˆ: ${diceType}é¢éª°ï¼Œçµæœ: ${result}`);
        });
      }
    });
  </script>

  <script id="settingsManager">
    document.addEventListener("DOMContentLoaded", function () {
      const saveSettingsBtn = document.getElementById("saveSettings");
      const modelSelect = document.getElementById("modelSelect");
      const apiKeyInput = document.getElementById("apiKey");
      const ollamaUrlInput = document.getElementById("ollamaUrl");
      const refreshModelsBtn = document.getElementById("refreshModels");
      const statusIndicator = document.getElementById("statusIndicator");
      const statusText = document.getElementById("statusText");

      loadSettings();
      loadAvailableModels();

      saveSettingsBtn.addEventListener("click", function () {
        const settings = {
          model: modelSelect.value,
          apiKey: apiKeyInput.value,
          ollamaUrl: ollamaUrlInput.value || 'http://localhost:11434',
        };

        if (!settings.model) {
          showNotification("è«‹é¸æ“‡ä¸€å€‹æ¨¡å‹", "error");
          return;
        }

        localStorage.setItem("dndSettings", JSON.stringify(settings));

        // åªåˆå§‹åŒ– AI ç³»çµ±ï¼Œä¸è‡ªå‹•é–‹å§‹æ•…äº‹
        gameAI.initialize(settings.model, settings.apiKey, settings.ollamaUrl)
          .then(() => {
            showNotification("è¨­å®šå·²ä¿å­˜ï¼ŒAI ç³»çµ±å·²åˆå§‹åŒ–", "success");
            updateConnectionStatus("connected");
          })
          .catch(error => {
            showNotification("AI ç³»çµ±åˆå§‹åŒ–å¤±æ•—", "error");
            updateConnectionStatus("error");
          });
      });

      refreshModelsBtn.addEventListener("click", function () {
        loadAvailableModels();
      });

      async function loadAvailableModels() {
        try {
          updateConnectionStatus("connecting");
          const ollamaUrl = ollamaUrlInput.value || 'http://localhost:11434';
          const response = await fetch(`${ollamaUrl}/api/tags`);
          if (!response.ok) {
            throw new Error('ç„¡æ³•é€£æ¥åˆ° Ollama');
          }

          const data = await response.json();

          // æ¸…ç©ºç¾æœ‰é¸é …
          modelSelect.innerHTML = '<option value="">é¸æ“‡ Ollama Model</option>';

          // æ·»åŠ å¯ç”¨æ¨¡å‹
          data.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.name;
            option.textContent = `${model.name} (${formatSize(model.size)})`;
            modelSelect.appendChild(option);
          });

          // å¦‚æœæœ‰ä¿å­˜çš„è¨­å®šï¼Œæ¢å¾©é¸æ“‡
          const savedSettings = localStorage.getItem("dndSettings");
          if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            modelSelect.value = settings.model || "";
            ollamaUrlInput.value = settings.ollamaUrl || 'http://localhost:11434';
          }

          updateConnectionStatus("ready");

        } catch (error) {
          console.error('ç„¡æ³•è¼‰å…¥æ¨¡å‹åˆ—è¡¨:', error);
          updateConnectionStatus("error");
          showNotification("ç„¡æ³•è¼‰å…¥ Ollama æ¨¡å‹åˆ—è¡¨ï¼Œè«‹ç¢ºèª Ollama æ˜¯å¦é‹è¡Œ", "error");
        }
      }


      function formatSize(bytes) {
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        if (bytes === 0) return '0 B';
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
      }

      function updateConnectionStatus(status) {
        switch (status) {
          case "connecting":
            statusIndicator.className = "w-3 h-3 rounded-full bg-yellow-500 animate-pulse";
            statusText.textContent = "é€£æ¥ä¸­...";
            statusText.className = "text-xs text-yellow-400";
            break;
          case "ready":
            statusIndicator.className = "w-3 h-3 rounded-full bg-green-500";
            statusText.textContent = "Ollama å·²å°±ç·’";
            statusText.className = "text-xs text-green-400";
            break;
          case "connected":
            statusIndicator.className = "w-3 h-3 rounded-full bg-blue-500";
            statusText.textContent = "AI å·²é€£æ¥";
            statusText.className = "text-xs text-blue-400";
            break;
          case "error":
            statusIndicator.className = "w-3 h-3 rounded-full bg-red-500";
            statusText.textContent = "é€£æ¥å¤±æ•—";
            statusText.className = "text-xs text-red-400";
            break;
          default:
            statusIndicator.className = "w-3 h-3 rounded-full bg-gray-500";
            statusText.textContent = "æœªé€£æ¥";
            statusText.className = "text-xs text-gray-400";
        }
      }

      function loadSettings() {
        const savedSettings = localStorage.getItem("dndSettings");
        if (savedSettings) {
          const settings = JSON.parse(savedSettings);
          apiKeyInput.value = settings.apiKey || "";
          ollamaUrlInput.value = settings.ollamaUrl || 'http://localhost:11434';
        }
      }

      function showNotification(message, type) {
        const notification = document.createElement("div");
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${type === "success" ? "bg-green-600" : "bg-red-600"
          }`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    });
  </script>

  <script id="aiSystem">
    class GameAI {
      constructor() {
        this.modelName = '';
        this.apiKey = '';
        this.ollamaUrl = 'http://localhost:11434';
        this.baseUrl = '';
        this.context = [];
      }

      async initialize(modelName, apiKey, ollamaUrl = 'http://localhost:11434') {
        this.modelName = modelName;
        this.apiKey = apiKey;
        this.ollamaUrl = ollamaUrl;
        this.baseUrl = `${ollamaUrl}/v1/chat/completions`;

        // åˆå§‹åŒ–ç³»çµ±æç¤º
        this.context = [{
          role: 'system',
          content: `ä½ æ˜¯ä¸€å€‹é¾èˆ‡åœ°ä¸‹åŸéŠæˆ²çš„ AI ä¸»æŒäººã€‚

âš ï¸ æ¥µé‡è¦è¦å‰‡ï¼šæ‰€æœ‰è¼¸å‡ºå¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œçµ•å°ä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼

ä½ éœ€è¦ï¼š
1. æ ¹æ“šç©å®¶çš„é¸æ“‡ç”Ÿæˆæœ‰è¶£çš„æ•…äº‹æƒ…ç¯€
2. åœ¨é©ç•¶çš„æ™‚å€™è¦æ±‚é€²è¡Œæ“²éª°æª¢å®šï¼Œæ ¼å¼ç‚ºï¼šã€Œéœ€è¦æ“²D20éª°å­ã€ï¼ˆæˆ–D12ã€D10ã€D6ï¼‰
3. ç•¶æ”¶åˆ°æ“²éª°çµæœæç¤ºæ™‚ï¼Œæ ¹æ“šçµæœæ±ºå®šå¾ŒçºŒç™¼å±•ï¼Œä¸¦æä¾›è§’è‰²æ•¸æ“šè®ŠåŒ–å»ºè­°ï¼š
   - æˆåŠŸæ™‚ï¼šçµ¦äºˆç¶“é©—å€¼ã€é‡‘å¹£ç­‰æ­£é¢çå‹µ
   - å¤±æ•—æ™‚ï¼šé€ æˆå‚·å®³ã€æ¶ˆè€—è³‡æºç­‰è² é¢æ•ˆæœ
   - å¤§æˆåŠŸ/å¤§å¤±æ•—ï¼šæ•ˆæœåŠ å€

4. **é‡è¦ï¼šç•¶è™•ç†æ“²éª°çµæœæ™‚ï¼Œå¿…é ˆæä¾›è§’è‰²æ•¸æ“šè®ŠåŒ–å»ºè­°**
   æ ¼å¼å¦‚ä¸‹ï¼š
   ===è§’è‰²è®ŠåŒ–å»ºè­°===
   HP_CHANGE: +5 æˆ– -10 (æ ¹æ“šæƒ…æ³)
   MP_CHANGE: -3 æˆ– +2 (æ ¹æ“šæƒ…æ³) 
   EXP_CHANGE: +15 æˆ– +30 (æ ¹æ“šæˆåŠŸç¨‹åº¦)
   GOLD_CHANGE: +5 æˆ– -2 (å¦‚é©ç”¨)
   REASON: è®ŠåŒ–åŸå› çš„ç°¡çŸ­èªªæ˜
   ===è®ŠåŒ–å»ºè­°çµæŸ===

5. æä¾›ä¸‰å€‹åˆç†çš„é¸é …ä¾›ç©å®¶é¸æ“‡
6. è¨˜ä½ç©å®¶çš„ç‹€æ…‹å’Œä¹‹å‰çš„é¸æ“‡

æ ¼å¼è¦æ±‚ï¼š
1. æ‰€æœ‰æ–‡å­—å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼‰
2. é‡è¦å…§å®¹ä½¿ç”¨ **ç²—é«”** æ¨™è¨˜
3. ä½¿ç”¨ç©ºè¡Œåˆ†éš”æ®µè½
4. é¸é …å¿…é ˆä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼ˆåŒ…å«åˆ†éš”ç·šï¼‰ï¼š

===é¸é …é–‹å§‹===
1. **é¸é …æ¨™é¡Œ** - é¸é …æè¿°
2. **é¸é …æ¨™é¡Œ** - é¸é …æè¿°
3. **é¸é …æ¨™é¡Œ** - é¸é …æè¿°
===é¸é …çµæŸ===

è§’è‰²æ•¸æ“šè®ŠåŒ–æŒ‡å—ï¼š
- HP_CHANGE: æˆ°é¬¥å‚·å®³ (-5 åˆ° -15)ã€æ²»ç™‚ (+3 åˆ° +10)ã€ä¼‘æ¯ (+1 åˆ° +5)
- MP_CHANGE: æ–½æ³• (-2 åˆ° -8)ã€å†¥æƒ³ (+2 åˆ° +5)ã€é­”æ³•æ¢å¾© (+1 åˆ° +3)
- EXP_CHANGE: æˆåŠŸå®ŒæˆæŒ‘æˆ° (+10 åˆ° +50)ã€è§£æ±ºè¬é¡Œ (+5 åˆ° +20)ã€æˆ°é¬¥å‹åˆ© (+15 åˆ° +30)
- GOLD_CHANGE: æˆ°åˆ©å“ (+5 åˆ° +50)ã€è³¼è²·ç‰©å“ (-10 åˆ° -100)ã€è³„è³‚ (-5 åˆ° -20)
- ITEM_REWARD: ç²å¾—ç‰©å“çå‹µï¼Œæ ¼å¼: ç‰©å“åç¨±|åœ–æ¨™|é¡å‹|æ•¸é‡|æè¿°
- EQUIP_REWARD: ç²å¾—è£å‚™çå‹µï¼Œæ ¼å¼: è£å‚™åç¨±|åœ–æ¨™|é¡å‹|å±¬æ€§åŠ æˆ|ç‰¹æ®Šæ•ˆæœ|æè¿°

ç‰©å“å’Œè£å‚™çå‹µä¾‹å­ï¼š
- ITEM_REWARD: æ²»ç™‚è—¥æ°´|ri-flask-line|item|2|æ¢å¾© 10-17 HP
- EQUIP_REWARD: çƒˆç„°åŠ|ri-sword-line|weapon|strength:3,dexterity:1||+3åŠ›é‡+1æ•æ·çš„ç«å±¬æ€§åŠ

åš´ç¦äº‹é …ï¼š
- çµ•å°ä¸è¦æä¾›ã€Œè·³éã€ã€ã€Œç•¥éã€ã€ã€Œç¹¼çºŒã€ç­‰ç„¡å¯¦éš›æ„ç¾©çš„é¸é …
- æ¯å€‹é¸é …éƒ½å¿…é ˆæ˜¯å…·é«”çš„è¡Œå‹•æˆ–æ±ºç­–
- é¸é …å¿…é ˆæ”¾åœ¨æ•…äº‹å…§å®¹çš„æœ€å¾Œ
- é¸é …å¿…é ˆä½¿ç”¨ä¸Šè¿°æ ¼å¼ï¼ŒåŒ…å«åˆ†éš”ç·š
- æ¯å€‹é¸é …å¿…é ˆåŒ…å«æ¨™é¡Œå’Œæè¿°
- æ¨™é¡Œå¿…é ˆç”¨ **ç²—é«”** æ¨™è¨˜
- å¿…é ˆæä¾›æ°å¥½ä¸‰å€‹é¸é …ï¼Œä¸èƒ½å¤šä¹Ÿä¸èƒ½å°‘
- çµ•å°ä¸è¦ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼Œæ‰€æœ‰æ–‡å­—éƒ½å¿…é ˆæ˜¯ç¹é«”ä¸­æ–‡
- ç•¶è™•ç†æ“²éª°çµæœæ™‚ï¼Œå¿…é ˆæä¾›è§’è‰²è®ŠåŒ–å»ºè­°ï¼Œä¸å¯çœç•¥`
        }];
      }

      async sendMessage(message) {
        try {
          if (!this.modelName) {
            throw new Error('è«‹å…ˆé¸æ“‡ä¸¦ä¿å­˜ AI æ¨¡å‹è¨­å®š');
          }

          // é¡¯ç¤º loading ç•«é¢
          this.showLoading('æ­£åœ¨ç”Ÿæˆæ•…äº‹å…§å®¹...');

          // æ›´æ–°é€£æ¥ç‹€æ…‹
          const statusIndicator = document.getElementById("statusIndicator");
          const statusText = document.getElementById("statusText");
          if (statusIndicator && statusText) {
            statusIndicator.className = "w-3 h-3 rounded-full bg-yellow-500 animate-pulse";
            statusText.textContent = "AI æ€è€ƒä¸­...";
            statusText.className = "text-xs text-yellow-400";
          }

          const response = await fetch(this.baseUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: this.modelName,
              messages: [...this.context, {
                role: 'user',
                content: message
              }],
              stream: false,
              temperature: 0.8,
              max_tokens: 1000
            })
          });

          if (!response.ok) {
            const errorData = await response.text();
            console.error('API éŒ¯èª¤å›æ‡‰:', errorData);

            if (response.status === 404) {
              throw new Error(`æ‰¾ä¸åˆ°æ¨¡å‹ "${this.modelName}"ï¼Œè«‹ç¢ºèªæ¨¡å‹åç¨±æ­£ç¢ºæˆ–é‡æ–°ä¸‹è¼‰æ¨¡å‹`);
            } else if (response.status === 500) {
              throw new Error('Ollama æœå‹™å™¨å…§éƒ¨éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ¨¡å‹æ˜¯å¦æ­£ç¢ºè¼‰å…¥');
            } else {
              throw new Error(`AI æœå‹™éŒ¯èª¤ (${response.status}): ${errorData}`);
            }
          }

          const data = await response.json();

          if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('AI å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          const aiResponse = data.choices[0].message.content;

          // æ›´æ–°å°è©±æ­·å²
          this.context.push(
            { role: 'user', content: message },
            { role: 'assistant', content: aiResponse }
          );

          // æ¢å¾©é€£æ¥ç‹€æ…‹
          if (statusIndicator && statusText) {
            statusIndicator.className = "w-3 h-3 rounded-full bg-blue-500";
            statusText.textContent = "AI å·²é€£æ¥";
            statusText.className = "text-xs text-blue-400";
          }

          // éš±è— loading ç•«é¢
          this.hideLoading();

          return aiResponse;
        } catch (error) {
          console.error('AI éŒ¯èª¤:', error);

          // æ›´æ–°éŒ¯èª¤ç‹€æ…‹
          const statusIndicator = document.getElementById("statusIndicator");
          const statusText = document.getElementById("statusText");
          if (statusIndicator && statusText) {
            statusIndicator.className = "w-3 h-3 rounded-full bg-red-500";
            statusText.textContent = "AI é€£æ¥éŒ¯èª¤";
            statusText.className = "text-xs text-red-400";
          }

          // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
          const notification = document.createElement("div");
          notification.className = "fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 bg-red-600 max-w-md";
          notification.innerHTML = `
            <div class="font-bold">AI ç³»çµ±éŒ¯èª¤</div>
            <div class="text-sm mt-1">${error.message}</div>
          `;
          document.body.appendChild(notification);

          setTimeout(() => {
            notification.remove();
          }, 5000);

          // éš±è— loading ç•«é¢
          this.hideLoading();

          return `**ç³»çµ±éŒ¯èª¤**: ${error.message}\n\nè«‹æª¢æŸ¥ï¼š\n1. Ollama æ˜¯å¦æ­£åœ¨é‹è¡Œ (é‹è¡Œ \`ollama serve\`)\n2. é¸æ“‡çš„æ¨¡å‹æ˜¯å¦å·²ä¸‹è¼‰\n3. ç¶²çµ¡é€£æ¥æ˜¯å¦æ­£å¸¸\n\næ‚¨å¯ä»¥å˜—è©¦é‡æ–°é¸æ“‡æ¨¡å‹æˆ–é‡å•Ÿ Ollama æœå‹™ã€‚`;
        }
      }

      showLoading(message = 'AI æ€è€ƒä¸­...', subtext = 'è«‹ç¨å€™') {
        const overlay = document.getElementById('loadingOverlay');
        const title = document.getElementById('loadingTitle');
        const subtitle = document.getElementById('loadingSubtext');

        if (overlay) {
          overlay.classList.remove('hidden');
          title.textContent = message;
          subtitle.textContent = subtext;
        }
      }

      hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.classList.add('hidden');
        }
      }
    }

    // åˆå§‹åŒ– AI ç³»çµ±
    const gameAI = new GameAI();
  </script>

  <script id="characterManager">
    class CharacterManager {
      constructor() {
        // åˆå§‹åŒ–è§’è‰²æ•¸æ“šçµæ§‹
        this.character = {
          personal: {
            name: "è‰¾ç‘å…‹Â·éµå¿ƒ",
            class: "æˆ°å£«",
            race: "äººé¡",
            level: 3,
            avatar: "https://readdy.ai/api/search-image?query=fantasy%20warrior%20character%20portrait%20with%20medieval%20armor%20and%20determined%20expression%2C%20detailed%20digital%20art%20style%2C%20warm%20lighting%2C%20heroic%20pose%2C%20fantasy%20game%20character%20design&width=200&height=200&seq=character001&orientation=squarish"
          },
          stats: {
            strength: 16,
            dexterity: 14,
            intelligence: 13
          },
          resources: {
            hp: { current: 42, max: 50 },
            mp: { current: 18, max: 25 },
            experience: { current: 850, max: 1000 }
          },
          inventory: {
            weapons: [
              { name: "é‹¼éµé•·åŠ", icon: "ri-sword-line", equipped: true }
            ],
            armor: [
              { name: "çš®é©ç›¾ç‰Œ", icon: "ri-shield-line", equipped: true }
            ],
            items: [
              { name: "æ²»ç™‚è—¥æ°´", icon: "ri-flask-line", quantity: 3 }
            ],
            gold: 127
          },
          statusEffects: []
        };

        // ç¶å®š DOM å…ƒç´ 
        this.characterPanel = document.querySelector('aside:first-of-type');
        this.bindElements();

        // åˆå§‹åŒ–äº‹ä»¶ç³»çµ±
        this.eventListeners = new Map();
        this.setupEventSystem();
      }

      bindElements() {
        // ç¶å®šéœ€è¦å‹•æ…‹æ›´æ–°çš„ DOM å…ƒç´ 
        this.elements = {
          name: this.characterPanel.querySelector('h3'),
          classLevel: this.characterPanel.querySelector('p'),
          avatar: this.characterPanel.querySelector('img'),
          strengthValue: this.characterPanel.querySelector('.text-red-400'),
          dexterityValue: this.characterPanel.querySelector('.text-green-400'),
          intelligenceValue: this.characterPanel.querySelector('.text-blue-400'),
          hpCurrent: this.characterPanel.querySelector('.text-red-400').closest('.space-y-3').querySelector('span:last-child'),
          hpBar: this.characterPanel.querySelector('.progress-bar'),
          mpCurrent: this.characterPanel.querySelector('.text-blue-400').closest('div').querySelector('span:last-child'),
          mpBar: this.characterPanel.querySelector('.bg-blue-500'),
          inventory: this.characterPanel.querySelector('.grid-cols-2')
        };
      }

      setupEventSystem() {
        // å‰µå»ºè‡ªå®šç¾©äº‹ä»¶ç³»çµ±
        this.eventBus = {
          listeners: new Map(),

          on: (event, callback) => {
            if (!this.eventBus.listeners.has(event)) {
              this.eventBus.listeners.set(event, []);
            }
            this.eventBus.listeners.get(event).push(callback);
          },

          emit: (event, data) => {
            if (this.eventBus.listeners.has(event)) {
              this.eventBus.listeners.get(event).forEach(callback => {
                callback(data);
              });
            }
          }
        };

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        this.eventBus.on('character.updated', (changes) => {
          this.renderCharacterPanel();
          this.showChangeNotification(changes);
        });
      }

      // æ›´æ–°è§’è‰²æ•¸æ“š
      updateCharacter(changes) {
        console.log('æ›´æ–°è§’è‰²æ•¸æ“š:', changes);

        const oldData = JSON.parse(JSON.stringify(this.character));

        // æ·±åº¦åˆä½µæ•¸æ“š
        this.deepMerge(this.character, changes);

        // é‡æ–°è¨ˆç®—å±¬æ€§ï¼ˆè™•ç†è£å‚™è®ŠåŒ–ï¼‰
        if (changes.inventory) {
          this.recalculateStats();
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦ç­‰ç´šæå‡
        if (changes.resources && changes.resources.experience) {
          this.checkLevelUp();
        }

        // è§¸ç™¼æ›´æ–°äº‹ä»¶
        this.eventBus.emit('character.updated', {
          changes: changes,
          oldData: oldData,
          newData: this.character
        });

        return this.character;
      }

      // æ·±åº¦åˆä½µå°è±¡
      deepMerge(target, source) {
        for (const key in source) {
          if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            if (!target[key]) target[key] = {};
            this.deepMerge(target[key], source[key]);
          } else {
            target[key] = source[key];
          }
        }
      }

      // æ¸²æŸ“è§’è‰²é¢æ¿
      renderCharacterPanel() {
        const { personal, stats, resources, inventory } = this.character;

        // æ›´æ–°åŸºæœ¬è³‡è¨Š
        if (this.elements.name) {
          this.elements.name.textContent = personal.name;
        }

        if (this.elements.classLevel) {
          this.elements.classLevel.textContent = `${personal.race}${personal.class} Â· ç­‰ç´š ${personal.level}`;
        }

        // æ›´æ–°å±¬æ€§å€¼
        if (this.elements.strengthValue) {
          this.elements.strengthValue.textContent = stats.strength;
        }
        if (this.elements.dexterityValue) {
          this.elements.dexterityValue.textContent = stats.dexterity;
        }
        if (this.elements.intelligenceValue) {
          this.elements.intelligenceValue.textContent = stats.intelligence;
        }

        // æ›´æ–°ç”Ÿå‘½å€¼
        if (this.elements.hpCurrent) {
          this.elements.hpCurrent.textContent = `${resources.hp.current}/${resources.hp.max}`;
        }
        if (this.elements.hpBar) {
          const hpPercentage = (resources.hp.current / resources.hp.max) * 100;
          this.elements.hpBar.style.width = `${hpPercentage}%`;
        }

        // æ›´æ–°é­”åŠ›å€¼
        if (this.elements.mpCurrent) {
          this.elements.mpCurrent.textContent = `${resources.mp.current}/${resources.mp.max}`;
        }
        if (this.elements.mpBar) {
          const mpPercentage = (resources.mp.current / resources.mp.max) * 100;
          this.elements.mpBar.style.width = `${mpPercentage}%`;
        }

        // æ›´æ–°è£å‚™é“å…·
        this.renderInventory();
      }

      // æ¸²æŸ“è£å‚™é“å…·
      renderInventory() {
        if (!this.elements.inventory) return;

        const { inventory } = this.character;
        const items = [
          ...inventory.weapons.filter(item => item.equipped),
          ...inventory.armor.filter(item => item.equipped),
          ...inventory.items.slice(0, 1), // åªé¡¯ç¤ºç¬¬ä¸€å€‹é“å…·
          { name: `é‡‘å¹£ x${inventory.gold}`, icon: "ri-coins-line", isGold: true }
        ];

        // æ¸…ç©ºç¾æœ‰å…§å®¹
        this.elements.inventory.innerHTML = '';

        // æ¸²æŸ“æ¯å€‹ç‰©å“
        items.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'bg-gray-800/50 rounded-lg p-3 text-center';

          let itemName = item.name;
          if (item.quantity && item.quantity > 1) {
            itemName += ` x${item.quantity}`;
          }

          itemDiv.innerHTML = `
            <div class="w-8 h-8 flex items-center justify-center mx-auto mb-1">
              <i class="${item.icon} ${item.isGold ? 'text-yellow-400' : item.equipped ? 'text-amber-400' : 'text-red-400'} text-lg"></i>
            </div>
            <div class="text-xs text-gray-300">${itemName}</div>
          `;

          this.elements.inventory.appendChild(itemDiv);
        });
      }

      // é¡¯ç¤ºè®ŠåŒ–é€šçŸ¥
      showChangeNotification(changeData) {
        const { changes } = changeData;

        // æª¢æŸ¥è³‡æºè®ŠåŒ–
        if (changes.resources) {
          if (changes.resources.hp) {
            const hpChange = changes.resources.hp.current - (changeData.oldData.resources.hp.current || 0);
            if (hpChange !== 0) {
              this.createFloatingText(
                hpChange > 0 ? `+${hpChange} HP` : `${hpChange} HP`,
                hpChange > 0 ? 'text-green-400' : 'text-red-400'
              );
            }
          }

          if (changes.resources.mp) {
            const mpChange = changes.resources.mp.current - (changeData.oldData.resources.mp.current || 0);
            if (mpChange !== 0) {
              this.createFloatingText(
                mpChange > 0 ? `+${mpChange} MP` : `${mpChange} MP`,
                mpChange > 0 ? 'text-blue-400' : 'text-blue-600'
              );
            }
          }
        }

        // æª¢æŸ¥ç¶“é©—å€¼è®ŠåŒ–
        if (changes.resources && changes.resources.experience) {
          const expChange = changes.resources.experience.current - (changeData.oldData.resources.experience.current || 0);
          if (expChange > 0) {
            this.createFloatingText(`+${expChange} EXP`, 'text-purple-400');
          }
        }
      }

      // å‰µå»ºæµ®å‹•æ–‡å­—æ•ˆæœ
      createFloatingText(text, colorClass) {
        const floatingText = document.createElement('div');
        floatingText.className = `fixed z-50 font-bold text-lg pointer-events-none ${colorClass}`;
        floatingText.textContent = text;
        floatingText.style.cssText = `
          left: 20px;
          top: 50%;
          transform: translateY(-50%);
          animation: floatUp 2s ease-out forwards;
        `;

        document.body.appendChild(floatingText);

        setTimeout(() => {
          floatingText.remove();
        }, 2000);
      }

      // ç²å–è§’è‰²æ•¸æ“š
      getCharacter() {
        return JSON.parse(JSON.stringify(this.character));
      }

      // ä¿å­˜è§’è‰²æ•¸æ“šåˆ°æœ¬åœ°å­˜å„²
      saveCharacter() {
        localStorage.setItem('dnd_character_data', JSON.stringify(this.character));
      }

      // å¾æœ¬åœ°å­˜å„²åŠ è¼‰è§’è‰²æ•¸æ“š
      loadCharacter() {
        const saved = localStorage.getItem('dnd_character_data');
        if (saved) {
          try {
            const savedCharacter = JSON.parse(saved);
            this.character = { ...this.character, ...savedCharacter };
            this.renderCharacterPanel();
          } catch (error) {
            console.error('åŠ è¼‰è§’è‰²æ•¸æ“šå¤±æ•—:', error);
          }
        }
      }

      // è£å‚™ç®¡ç†æ–¹æ³•
      equipItem(item) {
        console.log('è£å‚™ç‰©å“:', item);

        const { type } = item;
        const targetSlot = type === 'weapon' ? 'weapons' : type === 'armor' ? 'armor' : null;

        if (!targetSlot) {
          console.error('ç„¡æ•ˆçš„è£å‚™é¡å‹:', type);
          return false;
        }

        // å¸ä¸‹ç•¶å‰åŒé¡å‹è£å‚™
        this.character.inventory[targetSlot].forEach(equippedItem => {
          if (equippedItem.equipped) {
            equippedItem.equipped = false;
            console.log('å¸ä¸‹è£å‚™:', equippedItem.name);
          }
        });

        // æª¢æŸ¥æ˜¯å¦å·²åœ¨èƒŒåŒ…ä¸­
        const existingItem = this.character.inventory[targetSlot].find(invItem => invItem.name === item.name);

        if (existingItem) {
          existingItem.equipped = true;
        } else {
          // æ·»åŠ åˆ°èƒŒåŒ…ä¸¦è£å‚™
          item.equipped = true;
          this.character.inventory[targetSlot].push(item);
        }

        // é‡æ–°è¨ˆç®—å±¬æ€§åŠ æˆ
        this.recalculateStats();

        // è§¸ç™¼æ›´æ–°äº‹ä»¶
        this.eventBus.emit('character.updated', {
          changes: { inventory: this.character.inventory },
          oldData: this.character,
          newData: this.character
        });

        return true;
      }

      // å¸ä¸‹è£å‚™
      unequipItem(itemName) {
        console.log('å¸ä¸‹è£å‚™:', itemName);

        let found = false;

        ['weapons', 'armor'].forEach(slot => {
          const item = this.character.inventory[slot].find(item => item.name === itemName && item.equipped);
          if (item) {
            item.equipped = false;
            found = true;
          }
        });

        if (found) {
          this.recalculateStats();
          this.eventBus.emit('character.updated', {
            changes: { inventory: this.character.inventory },
            oldData: this.character,
            newData: this.character
          });
        }

        return found;
      }

      // æ·»åŠ ç‰©å“åˆ°èƒŒåŒ…
      addItem(item) {
        console.log('æ·»åŠ ç‰©å“:', item);

        if (item.type === 'weapon' || item.type === 'armor') {
          // è£å‚™é¡ç‰©å“
          const targetSlot = item.type === 'weapon' ? 'weapons' : 'armor';
          const existingItem = this.character.inventory[targetSlot].find(invItem => invItem.name === item.name);

          if (!existingItem) {
            this.character.inventory[targetSlot].push({
              ...item,
              equipped: false
            });
          }
        } else {
          // ä¸€èˆ¬ç‰©å“ï¼ˆå¯å †ç–Šï¼‰
          const existingItem = this.character.inventory.items.find(invItem => invItem.name === item.name);

          if (existingItem) {
            existingItem.quantity = (existingItem.quantity || 1) + (item.quantity || 1);
          } else {
            this.character.inventory.items.push({
              ...item,
              quantity: item.quantity || 1
            });
          }
        }

        this.eventBus.emit('character.updated', {
          changes: { inventory: this.character.inventory },
          oldData: this.character,
          newData: this.character
        });
      }

      // ä½¿ç”¨ç‰©å“
      useItem(itemName) {
        console.log('ä½¿ç”¨ç‰©å“:', itemName);

        const item = this.character.inventory.items.find(item => item.name === itemName);
        if (!item || item.quantity <= 0) {
          console.log('ç‰©å“ä¸å­˜åœ¨æˆ–æ•¸é‡ä¸è¶³');
          return false;
        }

        // å¥—ç”¨ç‰©å“æ•ˆæœ
        let effects = {};

        switch (itemName) {
          case 'æ²»ç™‚è—¥æ°´':
            const healAmount = Math.floor(Math.random() * 8) + 10; // 10-17 HP
            effects.resources = {
              hp: {
                current: Math.min(
                  this.character.resources.hp.max,
                  this.character.resources.hp.current + healAmount
                )
              }
            };
            this.createFloatingText(`+${healAmount} HP`, 'text-green-400');
            break;

          case 'é­”åŠ›è—¥æ°´':
            const manaAmount = Math.floor(Math.random() * 6) + 5; // 5-10 MP
            effects.resources = {
              mp: {
                current: Math.min(
                  this.character.resources.mp.max,
                  this.character.resources.mp.current + manaAmount
                )
              }
            };
            this.createFloatingText(`+${manaAmount} MP`, 'text-blue-400');
            break;

          case 'åŠ›é‡è—¥åŠ‘':
            effects.statusEffects = [
              ...this.character.statusEffects.filter(effect => effect.type !== 'strength_boost'),
              { type: 'strength_boost', duration: 3, bonus: 2 }
            ];
            this.createFloatingText('+2 åŠ›é‡ (3å›åˆ)', 'text-red-400');
            break;
        }

        // æ¶ˆè€—ç‰©å“
        item.quantity -= 1;
        if (item.quantity <= 0) {
          this.character.inventory.items = this.character.inventory.items.filter(i => i !== item);
        }

        // å¥—ç”¨æ•ˆæœ
        if (Object.keys(effects).length > 0) {
          this.updateCharacter(effects);
        }

        return true;
      }

      // é‡æ–°è¨ˆç®—è§’è‰²å±¬æ€§ï¼ˆåŒ…å«è£å‚™åŠ æˆï¼‰
      recalculateStats() {
        // ä½¿ç”¨åŸºç¤å±¬æ€§ï¼ˆåŒ…å«ç­‰ç´šåŠ æˆï¼‰æˆ–é è¨­å€¼
        const baseStats = this.character.baseStats || {
          strength: 16,
          dexterity: 14,
          intelligence: 13
        };

        // è¨ˆç®—è£å‚™åŠ æˆ
        let equipBonus = { strength: 0, dexterity: 0, intelligence: 0 };
        let hpBonus = 0;
        let mpBonus = 0;

        // æ­¦å™¨åŠ æˆ
        this.character.inventory.weapons.forEach(weapon => {
          if (weapon.equipped && weapon.stats) {
            Object.keys(weapon.stats).forEach(stat => {
              if (equipBonus.hasOwnProperty(stat)) {
                equipBonus[stat] += weapon.stats[stat];
              }
            });
            hpBonus += weapon.hpBonus || 0;
            mpBonus += weapon.mpBonus || 0;
          }
        });

        // é˜²å…·åŠ æˆ
        this.character.inventory.armor.forEach(armor => {
          if (armor.equipped && armor.stats) {
            Object.keys(armor.stats).forEach(stat => {
              if (equipBonus.hasOwnProperty(stat)) {
                equipBonus[stat] += armor.stats[stat];
              }
            });
            hpBonus += armor.hpBonus || 0;
            mpBonus += armor.mpBonus || 0;
          }
        });

        // ç‹€æ…‹æ•ˆæœåŠ æˆ
        let statusBonus = { strength: 0, dexterity: 0, intelligence: 0 };
        this.character.statusEffects.forEach(effect => {
          if (effect.type === 'strength_boost') {
            statusBonus.strength += effect.bonus;
          }
          // å¯ä»¥æ·»åŠ æ›´å¤šç‹€æ…‹æ•ˆæœé¡å‹
        });

        // æ›´æ–°æœ€çµ‚å±¬æ€§
        this.character.stats = {
          strength: baseStats.strength + equipBonus.strength + statusBonus.strength,
          dexterity: baseStats.dexterity + equipBonus.dexterity + statusBonus.dexterity,
          intelligence: baseStats.intelligence + equipBonus.intelligence + statusBonus.intelligence
        };

        // æ›´æ–°è³‡æºä¸Šé™ï¼ˆåŸºç¤å€¼ + ç­‰ç´šåŠ æˆ + è£å‚™åŠ æˆï¼‰
        const level = this.character.personal.level;
        const baseHpMax = 50 + ((level - 3) * 5); // æ¯ç´š+5 HP
        const baseMpMax = 25 + ((level - 3) * 3); // æ¯ç´š+3 MP

        this.character.resources.hp.max = baseHpMax + hpBonus;
        this.character.resources.mp.max = baseMpMax + mpBonus;
      }

      // è™•ç†ç‹€æ…‹æ•ˆæœæŒçºŒæ™‚é–“
      processStatusEffects() {
        let effectsChanged = false;

        this.character.statusEffects = this.character.statusEffects.filter(effect => {
          effect.duration--;
          if (effect.duration <= 0) {
            effectsChanged = true;
            this.createFloatingText(`${effect.type} æ•ˆæœçµæŸ`, 'text-gray-400');
            return false;
          }
          return true;
        });

        if (effectsChanged) {
          this.recalculateStats();
          this.renderCharacterPanel();
        }
      }

      // ç­‰ç´šæå‡ç³»çµ±
      checkLevelUp() {
        const { experience, level } = this.character.resources;
        const { personal } = this.character;

        if (experience.current >= experience.max) {
          // ç­‰ç´šæå‡ï¼
          const oldLevel = personal.level;
          personal.level += 1;

          // é‡ç½®ç¶“é©—å€¼
          experience.current = experience.current - experience.max;
          experience.max = this.calculateExpForNextLevel(personal.level);

          // æå‡å±¬æ€§ï¼ˆæ ¹æ“šè·æ¥­ä¸åŒæœ‰ä¸åŒåŠ æˆï¼‰
          const statGains = this.getStatGainsForLevelUp(personal.class);

          // é‡æ–°è¨ˆç®—åŸºç¤å±¬æ€§ï¼ˆåŒ…å«ç­‰ç´šåŠ æˆï¼‰
          this.recalculateBaseStats();

          // æå‡è³‡æºä¸Šé™
          const hpGain = Math.floor(Math.random() * 6) + 5; // 5-10 HP
          const mpGain = Math.floor(Math.random() * 4) + 2; // 2-5 MP

          this.character.resources.hp.max += hpGain;
          this.character.resources.mp.max += mpGain;

          // å®Œå…¨æ¢å¾©ç”Ÿå‘½å’Œé­”åŠ›
          this.character.resources.hp.current = this.character.resources.hp.max;
          this.character.resources.mp.current = this.character.resources.mp.max;

          // é¡¯ç¤ºç­‰ç´šæå‡æ•ˆæœ
          this.showLevelUpEffect(oldLevel, personal.level, statGains, hpGain, mpGain);

          // è§¸ç™¼æ›´æ–°äº‹ä»¶
          this.eventBus.emit('character.updated', {
            changes: {
              personal: { level: personal.level },
              resources: this.character.resources
            },
            oldData: { personal: { level: oldLevel } },
            newData: this.character
          });

          return true;
        }

        return false;
      }

      // è¨ˆç®—ä¸‹ä¸€ç­‰ç´šæ‰€éœ€ç¶“é©—å€¼
      calculateExpForNextLevel(level) {
        return Math.floor(1000 * Math.pow(1.5, level - 3)); // æŒ‡æ•¸å¢é•·
      }

      // æ ¹æ“šè·æ¥­ç²å¾—ç­‰ç´šæå‡æ™‚çš„å±¬æ€§åŠ æˆ
      getStatGainsForLevelUp(characterClass) {
        const gains = { strength: 0, dexterity: 0, intelligence: 0 };

        switch (characterClass) {
          case 'æˆ°å£«':
            gains.strength = Math.floor(Math.random() * 3) + 2; // 2-4
            gains.dexterity = Math.floor(Math.random() * 2) + 1; // 1-2
            gains.intelligence = Math.floor(Math.random() * 2); // 0-1
            break;
          case 'æ³•å¸«':
            gains.intelligence = Math.floor(Math.random() * 3) + 2; // 2-4
            gains.dexterity = Math.floor(Math.random() * 2) + 1; // 1-2
            gains.strength = Math.floor(Math.random() * 2); // 0-1
            break;
          case 'ç›œè³Š':
            gains.dexterity = Math.floor(Math.random() * 3) + 2; // 2-4
            gains.intelligence = Math.floor(Math.random() * 2) + 1; // 1-2
            gains.strength = Math.floor(Math.random() * 2) + 1; // 1-2
            break;
          default:
            // å¹³å‡æˆé•·
            gains.strength = Math.floor(Math.random() * 2) + 1;
            gains.dexterity = Math.floor(Math.random() * 2) + 1;
            gains.intelligence = Math.floor(Math.random() * 2) + 1;
        }

        return gains;
      }

      // é‡æ–°è¨ˆç®—åŸºç¤å±¬æ€§ï¼ˆåŒ…å«ç­‰ç´šåŠ æˆï¼‰
      recalculateBaseStats() {
        const level = this.character.personal.level;
        const characterClass = this.character.personal.class;

        // åŸºç¤å±¬æ€§æœƒéš¨ç­‰ç´šæˆé•·
        let baseStats = { strength: 16, dexterity: 14, intelligence: 13 };

        // ç­‰ç´šåŠ æˆï¼ˆæ¯ç´šå°å¹…æå‡ï¼‰
        const levelBonus = level - 3; // å¾ç­‰ç´š3é–‹å§‹è¨ˆç®—

        if (characterClass === 'æˆ°å£«') {
          baseStats.strength += Math.floor(levelBonus * 1.5);
          baseStats.dexterity += Math.floor(levelBonus * 0.8);
          baseStats.intelligence += Math.floor(levelBonus * 0.5);
        } else if (characterClass === 'æ³•å¸«') {
          baseStats.intelligence += Math.floor(levelBonus * 1.5);
          baseStats.dexterity += Math.floor(levelBonus * 0.8);
          baseStats.strength += Math.floor(levelBonus * 0.5);
        } else if (characterClass === 'ç›œè³Š') {
          baseStats.dexterity += Math.floor(levelBonus * 1.5);
          baseStats.intelligence += Math.floor(levelBonus * 0.8);
          baseStats.strength += Math.floor(levelBonus * 0.8);
        }

        // é‡æ–°è¨ˆç®—æœ€çµ‚å±¬æ€§ï¼ˆæœƒåœ¨ recalculateStats ä¸­åŠ ä¸Šè£å‚™å’Œç‹€æ…‹åŠ æˆï¼‰
        this.character.baseStats = baseStats;
        this.recalculateStats();
      }

      // é¡¯ç¤ºç­‰ç´šæå‡æ•ˆæœ
      showLevelUpEffect(oldLevel, newLevel, statGains, hpGain, mpGain) {
        // å‰µå»ºè¯éº—çš„ç­‰ç´šæå‡é€šçŸ¥
        const levelUpModal = document.createElement('div');
        levelUpModal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 level-up-modal';
        levelUpModal.innerHTML = `
          <div class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl p-8 text-center max-w-md mx-4 transform scale-0 level-up-content border-4 border-yellow-300">
            <div class="text-4xl font-bold text-white mb-4 animate-bounce">
              ğŸ‰ LEVEL UP! ğŸ‰
            </div>
            <div class="text-2xl font-bold text-white mb-6">
              ç­‰ç´š ${oldLevel} â†’ ${newLevel}
            </div>
            <div class="bg-white/20 rounded-lg p-4 mb-4">
              <div class="text-white font-medium mb-2">å±¬æ€§æå‡:</div>
              <div class="grid grid-cols-3 gap-2 text-sm">
                <div class="text-red-200">åŠ›é‡ +${statGains.strength}</div>
                <div class="text-green-200">æ•æ· +${statGains.dexterity}</div>
                <div class="text-blue-200">æ™ºåŠ› +${statGains.intelligence}</div>
              </div>
              <div class="mt-2 text-sm">
                <div class="text-red-200">ç”Ÿå‘½å€¼ä¸Šé™ +${hpGain}</div>
                <div class="text-blue-200">é­”åŠ›å€¼ä¸Šé™ +${mpGain}</div>
              </div>
            </div>
            <div class="text-white/90 text-sm mb-4">
              ç”Ÿå‘½å€¼å’Œé­”åŠ›å€¼å·²å®Œå…¨æ¢å¾©ï¼
            </div>
            <button class="bg-white text-orange-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition-colors" onclick="this.closest('.level-up-modal').remove()">
              ç¹¼çºŒå†’éšª
            </button>
          </div>
        `;

        document.body.appendChild(levelUpModal);

        // å‹•ç•«æ•ˆæœ
        setTimeout(() => {
          const content = levelUpModal.querySelector('.level-up-content');
          content.style.transform = 'scale(1)';
          content.style.transition = 'transform 0.5s ease-out';
        }, 100);

        // éŸ³æ•ˆæ¨¡æ“¬ï¼ˆå‰µå»ºæµ®å‹•æ–‡å­—ï¼‰
        setTimeout(() => {
          this.createFloatingText('LEVEL UP!', 'text-yellow-400 text-2xl font-bold');
        }, 500);
      }

      // é‡ç½®è§’è‰²æ•¸æ“š
      resetCharacter() {
        this.character = {
          personal: {
            name: "è‰¾ç‘å…‹Â·éµå¿ƒ",
            class: "æˆ°å£«",
            race: "äººé¡",
            level: 3,
            avatar: "https://readdy.ai/api/search-image?query=fantasy%20warrior%20character%20portrait%20with%20medieval%20armor%20and%20determined%20expression%2C%20detailed%20digital%20art%20style%2C%20warm%20lighting%2C%20heroic%20pose%2C%20fantasy%20game%20character%20design&width=200&height=200&seq=character001&orientation=squarish"
          },
          stats: { strength: 16, dexterity: 14, intelligence: 13 },
          resources: {
            hp: { current: 42, max: 50 },
            mp: { current: 18, max: 25 },
            experience: { current: 850, max: 1000 }
          },
          inventory: {
            weapons: [{
              name: "é‹¼éµé•·åŠ",
              icon: "ri-sword-line",
              type: "weapon",
              equipped: true,
              stats: { strength: 2 },
              description: "é‹’åˆ©çš„é‹¼éµé•·åŠï¼Œ+2 åŠ›é‡"
            }],
            armor: [{
              name: "çš®é©ç›¾ç‰Œ",
              icon: "ri-shield-line",
              type: "armor",
              equipped: true,
              hpBonus: 5,
              description: "å …å›ºçš„çš®é©ç›¾ç‰Œï¼Œ+5 ç”Ÿå‘½å€¼ä¸Šé™"
            }],
            items: [
              { name: "æ²»ç™‚è—¥æ°´", icon: "ri-flask-line", quantity: 3, description: "æ¢å¾© 10-17 HP" },
              { name: "é­”åŠ›è—¥æ°´", icon: "ri-flask-fill", quantity: 2, description: "æ¢å¾© 5-10 MP" }
            ],
            gold: 127
          },
          statusEffects: []
        };

        // é‡æ–°è¨ˆç®—å±¬æ€§
        this.recalculateStats();
        this.renderCharacterPanel();
      }
    }

    // æ·»åŠ æµ®å‹•æ–‡å­—å‹•ç•« CSS
    const floatingTextStyle = document.createElement('style');
    floatingTextStyle.textContent = `
      @keyframes floatUp {
        0% {
          opacity: 0;
          transform: translateY(-50%) translateX(0px);
        }
        20% {
          opacity: 1;
          transform: translateY(-50%) translateX(10px);
        }
        100% {
          opacity: 0;
          transform: translateY(-50%) translateX(30px) translateY(-30px);
        }
      }
    `;
    document.head.appendChild(floatingTextStyle);

    // å…¨åŸŸè§’è‰²ç®¡ç†å™¨å¯¦ä¾‹
    let characterManager;

    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–è§’è‰²ç®¡ç†å™¨
      characterManager = new CharacterManager();

      // åŠ è¼‰ä¿å­˜çš„è§’è‰²æ•¸æ“š
      characterManager.loadCharacter();

      // åˆå§‹æ¸²æŸ“
      characterManager.renderCharacterPanel();
    });
  </script>

  <script id="gameControls">
    document.addEventListener("DOMContentLoaded", function () {
      // æ·»åŠ éŠæˆ²æ§åˆ¶æŒ‰éˆ•åˆ° DOM
      const controlButtonsContainer = document.createElement('div');
      controlButtonsContainer.className = 'flex items-center space-x-2 mt-4';
      controlButtonsContainer.innerHTML = `
        <button id="saveGame" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-button text-sm font-medium transition-colors">
          <i class="ri-save-line mr-1"></i> å„²å­˜éŠæˆ²
        </button>
        <button id="restartGame" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-button text-sm font-medium transition-colors">
          <i class="ri-restart-line mr-1"></i> é‡æ–°é–‹å§‹
        </button>
        <button id="gameSettings" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-button text-sm font-medium transition-colors">
          <i class="ri-settings-3-line mr-1"></i> è¨­å®š
        </button>
        <button id="gameHelp" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-button text-sm font-medium transition-colors">
          <i class="ri-question-line mr-1"></i> èªªæ˜
        </button>
        <button id="testCharacter" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-button text-sm font-medium transition-colors">
          <i class="ri-flask-line mr-1"></i> æ¸¬è©¦
        </button>
      `;

      // å°‡æŒ‰éˆ•æ·»åŠ åˆ°å³å´é¢æ¿æœ€åº•éƒ¨
      document.querySelector('aside:last-child').appendChild(controlButtonsContainer);

      // ç²å–æŒ‰éˆ•å…ƒç´ 
      const saveGameBtn = document.getElementById("saveGame");
      const restartGameBtn = document.getElementById("restartGame");
      const gameSettingsBtn = document.getElementById("gameSettings");
      const gameHelpBtn = document.getElementById("gameHelp");
      const testCharacterBtn = document.getElementById("testCharacter");

      saveGameBtn.addEventListener("click", function () {
        const gameState = {
          timestamp: new Date().toISOString(),
          character: {
            name: "è‰¾ç‘å…‹Â·éµå¿ƒ",
            level: 3,
            hp: 42,
            maxHp: 50,
            mp: 18,
            maxMp: 25,
          },
          story: document.getElementById("storyContent").innerHTML,
        };

        localStorage.setItem("dndGameState", JSON.stringify(gameState));
        showGameNotification("éŠæˆ²é€²åº¦å·²ä¿å­˜");
      });

      restartGameBtn.addEventListener("click", function () {
        if (confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿç•¶å‰é€²åº¦å°‡æœƒä¸Ÿå¤±ã€‚")) {
          localStorage.removeItem("dndGameState");
          location.reload();
        }
      });

      gameSettingsBtn.addEventListener("click", function () {
        showGameNotification("è¨­å®šé¸å–®åŠŸèƒ½é–‹ç™¼ä¸­...");
      });

      gameHelpBtn.addEventListener("click", function () {
        showGameModal(
          "éŠæˆ²èªªæ˜",
          `
                          <div class="space-y-4 text-sm text-gray-300">
                              <p><strong class="text-white">éŠæˆ²ç©æ³•ï¼š</strong></p>
                              <ul class="list-disc list-inside space-y-2 ml-4">
                                  <li>é–±è®€æ•…äº‹å…§å®¹ï¼Œæ ¹æ“šæƒ…æ³é¸æ“‡è¡Œå‹•</li>
                                  <li>ä½¿ç”¨æ“²éª°å­ä¾†æ±ºå®šè¡Œå‹•çµæœ</li>
                                  <li>ç®¡ç†è§’è‰²çš„ç”Ÿå‘½å€¼å’Œé­”åŠ›å€¼</li>
                                  <li>æ”¶é›†è£å‚™å’Œé“å…·ä¾†å¢å¼·å¯¦åŠ›</li>
                              </ul>
                              <p><strong class="text-white">æ§åˆ¶èªªæ˜ï¼š</strong></p>
                              <ul class="list-disc list-inside space-y-2 ml-4">
                                  <li>é»æ“Šé¸é …æŒ‰éˆ•ä¾†åšå‡ºé¸æ“‡</li>
                                  <li>ä½¿ç”¨å³å´é¢æ¿çš„æ“²éª°æŒ‰éˆ•</li>
                                  <li>å¿«é€Ÿè¡Œå‹•æŒ‰éˆ•æä¾›å¸¸ç”¨æ“ä½œ</li>
                                  <li>æŠ€èƒ½å¿«æ·éµå¯å¿«é€Ÿä½¿ç”¨èƒ½åŠ›</li>
                              </ul>
                          </div>
                      `,
        );
      });

      testCharacterBtn.addEventListener("click", function () {
        if (characterManager) {
          // å‰µå»ºæ¸¬è©¦é¸é …
          const testOptions = [
            "æ¨¡æ“¬æˆ°é¬¥å‚·å®³ (-10 HP)",
            "ä½¿ç”¨æ²»ç™‚è—¥æ°´ (+15 HP)",
            "æ¶ˆè€—é­”åŠ› (-5 MP)",
            "ç²å¾—ç¶“é©—å€¼ (+50 EXP)",
            "ç²å¾—é‡‘å¹£ (+20 é‡‘å¹£)",
            "æ¸¬è©¦æ“²éª°æ•´åˆåŠŸèƒ½",
            "æ¸¬è©¦è£å‚™ç³»çµ±",
            "æ¸¬è©¦ç­‰ç´šæå‡",
            "æ¸¬è©¦ç‰©å“ä½¿ç”¨",
            "é‡ç½®è§’è‰²æ•¸æ“š"
          ];

          const selectedOption = prompt(`é¸æ“‡æ¸¬è©¦é¸é …ï¼š\n${testOptions.map((opt, i) => `${i + 1}. ${opt}`).join('\n')}`);
          const optionIndex = parseInt(selectedOption) - 1;

          if (optionIndex >= 0 && optionIndex < testOptions.length) {
            switch (optionIndex) {
              case 0: // æ¨¡æ“¬æˆ°é¬¥å‚·å®³
                characterManager.updateCharacter({
                  resources: {
                    hp: {
                      current: Math.max(0, characterManager.character.resources.hp.current - 10)
                    }
                  }
                });
                break;
              case 1: // ä½¿ç”¨æ²»ç™‚è—¥æ°´
                characterManager.updateCharacter({
                  resources: {
                    hp: {
                      current: Math.min(characterManager.character.resources.hp.max,
                        characterManager.character.resources.hp.current + 15)
                    }
                  }
                });
                break;
              case 2: // æ¶ˆè€—é­”åŠ›
                characterManager.updateCharacter({
                  resources: {
                    mp: {
                      current: Math.max(0, characterManager.character.resources.mp.current - 5)
                    }
                  }
                });
                break;
              case 3: // ç²å¾—ç¶“é©—å€¼
                characterManager.updateCharacter({
                  resources: {
                    experience: {
                      current: characterManager.character.resources.experience.current + 50
                    }
                  }
                });
                break;
              case 4: // ç²å¾—é‡‘å¹£
                characterManager.updateCharacter({
                  inventory: {
                    ...characterManager.character.inventory,
                    gold: characterManager.character.inventory.gold + 20
                  }
                });
                break;
              case 5: // æ¸¬è©¦æ“²éª°æ•´åˆåŠŸèƒ½
                const diceTestOptions = ["D20 æ¸¬è©¦", "D12 æ¸¬è©¦", "D10 æ¸¬è©¦", "D6 æ¸¬è©¦"];
                const diceChoice = prompt(`é¸æ“‡æ“²éª°æ¸¬è©¦ï¼š\n${diceTestOptions.map((opt, i) => `${i + 1}. ${opt}`).join('\n')}`);
                const diceIndex = parseInt(diceChoice) - 1;

                if (diceIndex >= 0 && diceIndex < diceTestOptions.length) {
                  const diceTypes = ['d20', 'd12', 'd10', 'd6'];
                  const selectedDice = diceTypes[diceIndex];

                  // æ¨¡æ“¬æ•…äº‹ç®¡ç†å™¨ç­‰å¾…æ“²éª°ç‹€æ…‹
                  if (storyManager) {
                    storyManager.waitingForDice = selectedDice;
                    showGameNotification(`è¨­ç½®ç­‰å¾… ${selectedDice.toUpperCase()} éª°å­ï¼Œè«‹é»æ“Šå°æ‡‰çš„æ“²éª°æŒ‰éˆ•æ¸¬è©¦æ•´åˆåŠŸèƒ½`);

                    // é«˜äº®å°æ‡‰çš„éª°å­æŒ‰éˆ•
                    storyManager.highlightDiceButton(selectedDice);

                    // æ¨¡æ“¬æ·»åŠ æ¸¬è©¦æ•…äº‹å…§å®¹
                    storyManager.appendToStory('system-message', `ğŸ® **æ¸¬è©¦æ¨¡å¼**ï¼šè«‹æ“² ${selectedDice.toUpperCase()} éª°å­æ¸¬è©¦æ•´åˆåŠŸèƒ½ï¼`);
                  } else {
                    showGameNotification("æ•…äº‹ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–");
                  }
                } else {
                  showGameNotification("ç„¡æ•ˆçš„æ“²éª°é¸æ“‡");
                }
                return; // æ—©æœŸè¿”å›ï¼Œä¸åŸ·è¡Œä¿å­˜

              case 6: // æ¸¬è©¦è£å‚™ç³»çµ±
                const equipTestOptions = [
                  "ç²å¾—é­”æ³•åŠ (+3åŠ›é‡, +2æ•æ·)",
                  "ç²å¾—é‹¼éµé§ç”² (+10HP, +1åŠ›é‡)",
                  "ç²å¾—æ™ºæ…§æ³•æ– (+4æ™ºåŠ›, +5MP)",
                  "å¸ä¸‹ç•¶å‰æ­¦å™¨",
                  "å¸ä¸‹ç•¶å‰é˜²å…·"
                ];
                const equipChoice = prompt(`è£å‚™æ¸¬è©¦ï¼š\n${equipTestOptions.map((opt, i) => `${i + 1}. ${opt}`).join('\n')}`);
                const equipIndex = parseInt(equipChoice) - 1;

                if (equipIndex >= 0 && equipIndex < equipTestOptions.length) {
                  switch (equipIndex) {
                    case 0: // é­”æ³•åŠ
                      characterManager.addItem({
                        name: "é­”æ³•åŠ",
                        icon: "ri-sword-line",
                        type: "weapon",
                        stats: { strength: 3, dexterity: 2 },
                        description: "æ•£ç™¼ç¥ç§˜å…‰èŠ’çš„é­”æ³•åŠ"
                      });
                      characterManager.equipItem({
                        name: "é­”æ³•åŠ",
                        icon: "ri-sword-line",
                        type: "weapon",
                        stats: { strength: 3, dexterity: 2 },
                        description: "æ•£ç™¼ç¥ç§˜å…‰èŠ’çš„é­”æ³•åŠ"
                      });
                      showGameNotification("ç²å¾—ä¸¦è£å‚™äº†é­”æ³•åŠï¼");
                      break;
                    case 1: // é‹¼éµé§ç”²
                      characterManager.addItem({
                        name: "é‹¼éµé§ç”²",
                        icon: "ri-shield-line",
                        type: "armor",
                        stats: { strength: 1 },
                        hpBonus: 10,
                        description: "åšé‡çš„é‹¼éµé§ç”²"
                      });
                      characterManager.equipItem({
                        name: "é‹¼éµé§ç”²",
                        icon: "ri-shield-line",
                        type: "armor",
                        stats: { strength: 1 },
                        hpBonus: 10,
                        description: "åšé‡çš„é‹¼éµé§ç”²"
                      });
                      showGameNotification("ç²å¾—ä¸¦è£å‚™äº†é‹¼éµé§ç”²ï¼");
                      break;
                    case 2: // æ™ºæ…§æ³•æ–
                      characterManager.addItem({
                        name: "æ™ºæ…§æ³•æ–",
                        icon: "ri-magic-line",
                        type: "weapon",
                        stats: { intelligence: 4 },
                        mpBonus: 5,
                        description: "è˜Šå«å¤è€æ™ºæ…§çš„æ³•æ–"
                      });
                      characterManager.equipItem({
                        name: "æ™ºæ…§æ³•æ–",
                        icon: "ri-magic-line",
                        type: "weapon",
                        stats: { intelligence: 4 },
                        mpBonus: 5,
                        description: "è˜Šå«å¤è€æ™ºæ…§çš„æ³•æ–"
                      });
                      showGameNotification("ç²å¾—ä¸¦è£å‚™äº†æ™ºæ…§æ³•æ–ï¼");
                      break;
                    case 3: // å¸ä¸‹æ­¦å™¨
                      const currentWeapon = characterManager.character.inventory.weapons.find(w => w.equipped);
                      if (currentWeapon) {
                        characterManager.unequipItem(currentWeapon.name);
                        showGameNotification(`å¸ä¸‹äº† ${currentWeapon.name}`);
                      } else {
                        showGameNotification("æ²’æœ‰è£å‚™æ­¦å™¨");
                      }
                      break;
                    case 4: // å¸ä¸‹é˜²å…·
                      const currentArmor = characterManager.character.inventory.armor.find(a => a.equipped);
                      if (currentArmor) {
                        characterManager.unequipItem(currentArmor.name);
                        showGameNotification(`å¸ä¸‹äº† ${currentArmor.name}`);
                      } else {
                        showGameNotification("æ²’æœ‰è£å‚™é˜²å…·");
                      }
                      break;
                  }
                }
                return; // æ—©æœŸè¿”å›

              case 7: // æ¸¬è©¦ç­‰ç´šæå‡
                const expNeeded = characterManager.character.resources.experience.max - characterManager.character.resources.experience.current;
                characterManager.updateCharacter({
                  resources: {
                    experience: {
                      current: characterManager.character.resources.experience.current + expNeeded
                    }
                  }
                });
                showGameNotification("ç¶“é©—å€¼å·²æ»¿ï¼Œè§¸ç™¼ç­‰ç´šæå‡ï¼");
                return; // æ—©æœŸè¿”å›

              case 8: // æ¸¬è©¦ç‰©å“ä½¿ç”¨
                const itemTestOptions = [
                  "ä½¿ç”¨æ²»ç™‚è—¥æ°´",
                  "ä½¿ç”¨é­”åŠ›è—¥æ°´",
                  "æ·»åŠ åŠ›é‡è—¥åŠ‘ä¸¦ä½¿ç”¨"
                ];
                const itemChoice = prompt(`ç‰©å“æ¸¬è©¦ï¼š\n${itemTestOptions.map((opt, i) => `${i + 1}. ${opt}`).join('\n')}`);
                const itemIndex = parseInt(itemChoice) - 1;

                if (itemIndex >= 0 && itemIndex < itemTestOptions.length) {
                  switch (itemIndex) {
                    case 0: // ä½¿ç”¨æ²»ç™‚è—¥æ°´
                      if (characterManager.useItem("æ²»ç™‚è—¥æ°´")) {
                        showGameNotification("ä½¿ç”¨äº†æ²»ç™‚è—¥æ°´");
                      } else {
                        showGameNotification("æ²’æœ‰æ²»ç™‚è—¥æ°´");
                      }
                      break;
                    case 1: // ä½¿ç”¨é­”åŠ›è—¥æ°´
                      if (characterManager.useItem("é­”åŠ›è—¥æ°´")) {
                        showGameNotification("ä½¿ç”¨äº†é­”åŠ›è—¥æ°´");
                      } else {
                        showGameNotification("æ²’æœ‰é­”åŠ›è—¥æ°´");
                      }
                      break;
                    case 2: // æ·»åŠ ä¸¦ä½¿ç”¨åŠ›é‡è—¥åŠ‘
                      characterManager.addItem({
                        name: "åŠ›é‡è—¥åŠ‘",
                        icon: "ri-flask-fill",
                        quantity: 1,
                        description: "æš«æ™‚å¢åŠ  +2 åŠ›é‡"
                      });
                      characterManager.useItem("åŠ›é‡è—¥åŠ‘");
                      showGameNotification("ç²å¾—ä¸¦ä½¿ç”¨äº†åŠ›é‡è—¥åŠ‘ï¼");
                      break;
                  }
                }
                return; // æ—©æœŸè¿”å›

              case 9: // é‡ç½®è§’è‰²æ•¸æ“š
                characterManager.resetCharacter();
                showGameNotification("è§’è‰²æ•¸æ“šå·²é‡ç½®");
                break;
            }

            if (optionIndex < 5) {
              // ä¿å­˜è§’è‰²æ•¸æ“š
              characterManager.saveCharacter();
              showGameNotification(`æ¸¬è©¦å®Œæˆï¼š${testOptions[optionIndex]}`);
            }
          }
        } else {
          showGameNotification("è§’è‰²ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–");
        }
      });

      function showGameNotification(message) {
        const notification = document.createElement("div");
        notification.className =
          "fixed bottom-4 right-4 bg-gray-800 border border-gray-600 px-4 py-2 rounded-lg text-white z-50";
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      function showGameModal(title, content) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex items-center justify-center z-50";
        modal.innerHTML = `
                          <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 max-w-md w-full mx-4">
                              <h3 class="text-xl font-bold text-white mb-4">${title}</h3>
                              ${content}
                              <button class="mt-4 bg-primary hover:bg-blue-600 px-4 py-2 rounded-button text-white w-full !rounded-button whitespace-nowrap">
                                  ç¢ºå®š
                              </button>
                          </div>
                      `;

        document.body.appendChild(modal);

        modal.addEventListener("click", function (e) {
          if (e.target === modal || e.target.tagName === "BUTTON") {
            modal.remove();
          }
        });
      }
    });
  </script>
</body>

</html>
